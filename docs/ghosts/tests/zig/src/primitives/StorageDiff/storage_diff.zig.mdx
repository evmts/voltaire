---
title: '[Zig] src/primitives/StorageDiff/storage_diff.zig'
source: 'src/primitives/StorageDiff/storage_diff.zig'
---

> Auto-generated from Zig tests in: src/primitives/StorageDiff/storage_diff.zig

### StorageDiff.init creates empty diff

```zig
test "StorageDiff.init creates empty diff" {
    const address = Address.Address{ .bytes = [_]u8{0xaa} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    try std.testing.expect(isEmpty(&diff));
    try std.testing.expectEqual(@as(usize, 0), size(&diff));
    try std.testing.expectEqualSlices(u8, &address.bytes, &getAddress(&diff).bytes);
}
```

### StorageDiff.setChange adds change

```zig
test "StorageDiff.setChange adds change" {
    const address = Address.Address{ .bytes = [_]u8{0xbb} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const old_value: [32]u8 = [_]u8{0x11} ** 32;
    const new_value: [32]u8 = [_]u8{0x22} ** 32;

    try setChange(&diff, slot, old_value, new_value);

    try std.testing.expect(!isEmpty(&diff));
    try std.testing.expectEqual(@as(usize, 1), size(&diff));
    try std.testing.expect(hasSlot(&diff, slot));

    const change = getChange(&diff, slot);
    try std.testing.expect(change != null);
    try std.testing.expectEqualSlices(u8, &old_value, &change.?.from.?);
    try std.testing.expectEqualSlices(u8, &new_value, &change.?.to.?);
}
```

### StorageDiff.getKeys returns all slots

```zig
test "StorageDiff.getKeys returns all slots" {
    const address = Address.Address{ .bytes = [_]u8{0xcc} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot1: [32]u8 = [_]u8{0x01} ** 32;
    const slot2: [32]u8 = [_]u8{0x02} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff, slot1, null, value);
    try setChange(&diff, slot2, null, value);

    const keys = try getKeys(&diff, std.testing.allocator);
    defer std.testing.allocator.free(keys);

    try std.testing.expectEqual(@as(usize, 2), keys.len);
}
```

### StorageDiff.isCreated detects slot creation

```zig
test "StorageDiff.isCreated detects slot creation" {
    const address = Address.Address{ .bytes = [_]u8{0xdd} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff, slot, null, value);

    try std.testing.expect(isCreated(&diff, slot));
    try std.testing.expect(!isDeleted(&diff, slot));
    try std.testing.expect(!isModified(&diff, slot));
}
```

### StorageDiff.isDeleted detects slot deletion

```zig
test "StorageDiff.isDeleted detects slot deletion" {
    const address = Address.Address{ .bytes = [_]u8{0xee} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff, slot, value, null);

    try std.testing.expect(!isCreated(&diff, slot));
    try std.testing.expect(isDeleted(&diff, slot));
    try std.testing.expect(!isModified(&diff, slot));
}
```

### StorageDiff.isModified detects slot modification

```zig
test "StorageDiff.isModified detects slot modification" {
    const address = Address.Address{ .bytes = [_]u8{0xff} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const old_value: [32]u8 = [_]u8{0x11} ** 32;
    const new_value: [32]u8 = [_]u8{0x22} ** 32;

    try setChange(&diff, slot, old_value, new_value);

    try std.testing.expect(!isCreated(&diff, slot));
    try std.testing.expect(!isDeleted(&diff, slot));
    try std.testing.expect(isModified(&diff, slot));
}
```

### StorageDiff.removeChange removes change

```zig
test "StorageDiff.removeChange removes change" {
    const address = Address.Address{ .bytes = [_]u8{0x11} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff, slot, null, value);
    try std.testing.expect(hasSlot(&diff, slot));

    removeChange(&diff, slot);
    try std.testing.expect(!hasSlot(&diff, slot));
}
```

### StorageDiff.clear removes all changes

```zig
test "StorageDiff.clear removes all changes" {
    const address = Address.Address{ .bytes = [_]u8{0x22} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    const slot1: [32]u8 = [_]u8{0x01} ** 32;
    const slot2: [32]u8 = [_]u8{0x02} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff, slot1, null, value);
    try setChange(&diff, slot2, null, value);
    try std.testing.expectEqual(@as(usize, 2), size(&diff));

    clear(&diff);
    try std.testing.expect(isEmpty(&diff));
}
```

### StorageDiff.equals compares diffs

```zig
test "StorageDiff.equals compares diffs" {
    const address = Address.Address{ .bytes = [_]u8{0x33} ** 20 };

    var diff1 = init(std.testing.allocator, address);
    defer diff1.deinit();

    var diff2 = init(std.testing.allocator, address);
    defer diff2.deinit();

    const slot: [32]u8 = [_]u8{0x00} ** 32;
    const value: [32]u8 = [_]u8{0xff} ** 32;

    try setChange(&diff1, slot, null, value);
    try setChange(&diff2, slot, null, value);

    try std.testing.expect(equals(&diff1, &diff2));

    // Different value
    var diff3 = init(std.testing.allocator, address);
    defer diff3.deinit();

    const other_value: [32]u8 = [_]u8{0xee} ** 32;
    try setChange(&diff3, slot, null, other_value);

    try std.testing.expect(!equals(&diff1, &diff3));
}
```

### StorageDiff.equals different addresses

```zig
test "StorageDiff.equals different addresses" {
    const address1 = Address.Address{ .bytes = [_]u8{0x44} ** 20 };
    const address2 = Address.Address{ .bytes = [_]u8{0x55} ** 20 };

    var diff1 = init(std.testing.allocator, address1);
    defer diff1.deinit();

    var diff2 = init(std.testing.allocator, address2);
    defer diff2.deinit();

    try std.testing.expect(!equals(&diff1, &diff2));
}
```

### StorageDiff.fromJson parses storage changes

```zig
test "StorageDiff.fromJson parses storage changes" {
    const json_input =
        \\{"pre":{"storage":{"0x0000000000000000000000000000000000000000000000000000000000000001":"0x0000000000000000000000000000000000000000000000000000000000000064"}},"post":{"storage":{"0x0000000000000000000000000000000000000000000000000000000000000001":"0x00000000000000000000000000000000000000000000000000000000000000c8"}}}
    ;

    const address = Address.Address{ .bytes = [_]u8{0xaa} ** 20 };
    var diff = try fromJson(std.testing.allocator, address, json_input);
    defer diff.deinit();

    try std.testing.expect(!isEmpty(&diff));
    try std.testing.expectEqual(@as(usize, 1), size(&diff));

    var slot: [32]u8 = [_]u8{0} ** 32;
    slot[31] = 0x01;

    const change = getChange(&diff, slot);
    try std.testing.expect(change != null);

    // 0x64 = 100 (from), 0xc8 = 200 (to)
    var expected_from: [32]u8 = [_]u8{0} ** 32;
    expected_from[31] = 0x64;
    try std.testing.expectEqualSlices(u8, &expected_from, &change.?.from.?);

    var expected_to: [32]u8 = [_]u8{0} ** 32;
    expected_to[31] = 0xc8;
    try std.testing.expectEqualSlices(u8, &expected_to, &change.?.to.?);
}
```

### StorageDiff.fromJson parses new slot

```zig
test "StorageDiff.fromJson parses new slot" {
    const json_input =
        \\{"pre":{},"post":{"storage":{"0x0000000000000000000000000000000000000000000000000000000000000002":"0x00000000000000000000000000000000000000000000000000000000000003e8"}}}
    ;

    const address = Address.Address{ .bytes = [_]u8{0xbb} ** 20 };
    var diff = try fromJson(std.testing.allocator, address, json_input);
    defer diff.deinit();

    var slot: [32]u8 = [_]u8{0} ** 32;
    slot[31] = 0x02;

    try std.testing.expect(isCreated(&diff, slot));

    const change = getChange(&diff, slot);
    try std.testing.expect(change != null);
    try std.testing.expect(change.?.from == null);

    // 0x3e8 = 1000
    var expected_to: [32]u8 = [_]u8{0} ** 32;
    expected_to[30] = 0x03;
    expected_to[31] = 0xe8;
    try std.testing.expectEqualSlices(u8, &expected_to, &change.?.to.?);
}
```

### StorageDiff.toJson produces valid output

```zig
test "StorageDiff.toJson produces valid output" {
    const address = Address.Address{ .bytes = [_]u8{0xcc} ** 20 };
    var diff = init(std.testing.allocator, address);
    defer diff.deinit();

    var slot: [32]u8 = [_]u8{0} ** 32;
    slot[31] = 0x05;

    var old_val: [32]u8 = [_]u8{0} ** 32;
    old_val[31] = 0x0a; // 10

    var new_val: [32]u8 = [_]u8{0} ** 32;
    new_val[31] = 0x14; // 20

    try setChange(&diff, slot, old_val, new_val);

    const json_output = try toJson(&diff, std.testing.allocator);
    defer std.testing.allocator.free(json_output);

    // Verify structure
    try std.testing.expect(std.mem.indexOf(u8, json_output, "\"address\":\"") != null);
    try std.testing.expect(std.mem.indexOf(u8, json_output, "\"pre\":{\"storage\":{") != null);
    try std.testing.expect(std.mem.indexOf(u8, json_output, "\"post\":{\"storage\":{") != null);
}
```
