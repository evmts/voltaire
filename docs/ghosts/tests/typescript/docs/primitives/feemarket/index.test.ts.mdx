---
title: '[TS/JS] docs/primitives/feemarket/index.test.ts'
source: 'docs/primitives/feemarket/index.test.ts'
---

> Auto-generated from test file: docs/primitives/feemarket/index.test.ts

```typescript
/**
 * Tests for docs/primitives/feemarket/index.mdx
 *
 * Validates that all code examples in the FeeMarket documentation work correctly.
 * FeeMarket provides EIP-1559 & EIP-4844 fee market calculations.
 */
import { describe, expect, it } from "vitest";

describe("FeeMarket Documentation - index.mdx", () => {
	describe("EIP-1559 Base Fee Calculation", () => {
		it("should calculate next base fee with BaseFee()", async () => {
			const { BaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Calculate next base fee based on parent block
			const nextBaseFee = BaseFee(
				30_000_000n, // parent gas used
				30_000_000n, // parent gas limit
				1_000_000_000n, // parent base fee (1 gwei)
			);

			// Base fee should be calculated deterministically
			expect(typeof nextBaseFee).toBe("bigint");
			expect(nextBaseFee).toBeGreaterThan(0n);
		});

		it("should increase base fee when block is full", async () => {
			const { BaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			const parentBaseFee = 1_000_000_000n; // 1 gwei
			const gasLimit = 30_000_000n;

			// Full block (gas used = gas limit)
			const nextBaseFee = BaseFee(gasLimit, gasLimit, parentBaseFee);

			// Base fee should increase when block is full
			expect(nextBaseFee).toBeGreaterThan(parentBaseFee);
		});

		it("should keep base fee same when block is empty", async () => {
			const { BaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			const parentBaseFee = 1_000_000_000n; // 1 gwei
			const gasLimit = 30_000_000n;

			// Empty block (gas used = 0) - per EIP-1559, base fee stays same
			const nextBaseFee = BaseFee(0n, gasLimit, parentBaseFee);

			// Base fee should stay same when block is empty
			expect(nextBaseFee).toBe(parentBaseFee);
		});
	});

	describe("EIP-4844 Blob Base Fee Calculation", () => {
		it("should calculate blob base fee with BlobBaseFee()", async () => {
			const { BlobBaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Calculate blob base fee based on excess blob gas
			const blobBaseFee = BlobBaseFee(393216n); // Some excess blob gas

			expect(typeof blobBaseFee).toBe("bigint");
			expect(blobBaseFee).toBeGreaterThan(0n);
		});

		it("should return minimum blob base fee when no excess", async () => {
			const { BlobBaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// No excess blob gas
			const blobBaseFee = BlobBaseFee(0n);

			// Should return minimum blob base fee (1 wei)
			expect(blobBaseFee).toBe(1n);
		});

		it("should increase blob base fee with higher excess", async () => {
			const { BlobBaseFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Need much larger difference to see effect due to update fraction
			const lowExcess = BlobBaseFee(0n);
			const highExcess = BlobBaseFee(10_000_000n);

			// Higher excess should result in higher or equal blob base fee
			expect(highExcess).toBeGreaterThanOrEqual(lowExcess);
		});
	});

	describe("Transaction Fee Calculations", () => {
		it("should calculate transaction fee with calculateTxFee()", async () => {
			const { calculateTxFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// calculateTxFee returns { effectiveGasPrice, priorityFee, baseFee }
			const result = calculateTxFee({
				maxFeePerGas: 100_000_000_000n, // 100 gwei
				maxPriorityFeePerGas: 1_000_000_000n, // 1 gwei
				baseFee: 30_000_000_000n, // 30 gwei
			});

			expect(result).toBeDefined();
			expect(typeof result.effectiveGasPrice).toBe("bigint");
			expect(typeof result.priorityFee).toBe("bigint");
			expect(result.baseFee).toBe(30_000_000_000n);
		});

		it("should calculate blob transaction fee with calculateBlobTxFee()", async () => {
			const { calculateBlobTxFee } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			const result = calculateBlobTxFee({
				maxFeePerGas: 100_000_000_000n,
				maxPriorityFeePerGas: 1_000_000_000n,
				baseFee: 30_000_000_000n,
				maxFeePerBlobGas: 10_000_000n,
				blobBaseFee: 1_000_000n,
				blobCount: 2n,
			});

			expect(result).toBeDefined();
			expect(typeof result.totalBlobFee).toBe("bigint");
			expect(typeof result.blobGasPrice).toBe("bigint");
		});
	});

	describe("Excess Blob Gas Calculation", () => {
		it("should calculate excess blob gas with calculateExcessBlobGas()", async () => {
			const { calculateExcessBlobGas } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Function takes raw bigints: (parentExcessBlobGas, parentBlobGasUsed)
			const excess = calculateExcessBlobGas(0n, 524288n); // 4 blobs worth

			expect(typeof excess).toBe("bigint");
		});
	});

	describe("Transaction Inclusion Check", () => {
		it("should check if transaction can be included with canIncludeTx()", async () => {
			const { canIncludeTx } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Transaction with sufficient max fee
			const canIncludeHigh = canIncludeTx({
				maxFeePerGas: 100_000_000_000n, // 100 gwei
				baseFee: 30_000_000_000n, // 30 gwei
			});
			expect(canIncludeHigh).toBe(true);

			// Transaction with insufficient max fee
			const canIncludeLow = canIncludeTx({
				maxFeePerGas: 20_000_000_000n, // 20 gwei (less than base fee)
				baseFee: 30_000_000_000n, // 30 gwei
			});
			expect(canIncludeLow).toBe(false);
		});
	});

	describe("Base Fee Projection", () => {
		it("should project future base fees with projectBaseFees()", async () => {
			const { projectBaseFees } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// projectBaseFees takes (initialState, blocks, avgGasUsed, avgBlobGasUsed?)
			const initialState = {
				gasUsed: 15_000_000n,
				gasLimit: 30_000_000n,
				baseFee: 30_000_000_000n,
				excessBlobGas: 0n,
				blobGasUsed: 0n,
			};

			const projections = projectBaseFees(initialState, 5, 15_000_000n, 0n);

			expect(Array.isArray(projections)).toBe(true);
			expect(projections.length).toBe(5);
			// All projections should be bigints
			for (const projection of projections) {
				expect(typeof projection).toBe("bigint");
			}
		});
	});

	describe("Validation", () => {
		it("should validate transaction fee params with validateTxFeeParams()", async () => {
			const { validateTxFeeParams } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Valid params
			expect(() =>
				validateTxFeeParams({
					maxFeePerGas: 100_000_000_000n,
					maxPriorityFeePerGas: 1_000_000_000n,
				}),
			).not.toThrow();
		});

		it("should validate state with validateState()", async () => {
			const { validateState } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// Valid state
			expect(() =>
				validateState({
					baseFee: 30_000_000_000n,
					gasUsed: 15_000_000n,
					gasLimit: 30_000_000n,
					blobBaseFee: 1n,
					blobGasUsed: 0n,
					excessBlobGas: 0n,
				}),
			).not.toThrow();
		});
	});

	describe("Unit Conversions", () => {
		it("should convert gwei to wei with gweiToWei()", async () => {
			const { gweiToWei } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// gweiToWei takes number, not bigint
			const wei = gweiToWei(1);
			expect(wei).toBe(1_000_000_000n);
		});

		it("should convert wei to gwei with weiToGwei()", async () => {
			const { weiToGwei } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			// weiToGwei returns string, not bigint
			const gwei = weiToGwei(1_000_000_000n);
			expect(typeof gwei).toBe("string");
			expect(gwei).toBe("1.000000000");
		});
	});

	describe("EIP-1559 Constants", () => {
		it("should export Eip1559 constants namespace", async () => {
			const { Eip1559 } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			expect(Eip1559).toBeDefined();
			// Check for common EIP-1559 constants
			expect(typeof Eip1559.BASE_FEE_CHANGE_DENOMINATOR).toBe("bigint");
			expect(typeof Eip1559.ELASTICITY_MULTIPLIER).toBe("bigint");
			expect(typeof Eip1559.MIN_BASE_FEE).toBe("bigint");
		});
	});

	describe("EIP-4844 Constants", () => {
		it("should export Eip4844 constants namespace", async () => {
			const { Eip4844 } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			expect(Eip4844).toBeDefined();
			// Check for common EIP-4844 constants
			expect(typeof Eip4844.TARGET_BLOB_GAS_PER_BLOCK).toBe("bigint");
			expect(typeof Eip4844.MAX_BLOB_GAS_PER_BLOCK).toBe("bigint");
			expect(typeof Eip4844.BLOB_BASE_FEE_UPDATE_FRACTION).toBe("bigint");
		});
	});

	describe("State Namespace", () => {
		it("should have State namespace with next() method", async () => {
			const { State } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			expect(State).toBeDefined();
			expect(typeof State.next).toBe("function");
		});

		it("should have State namespace with getBlobBaseFee() method", async () => {
			const { State } = await import(
				"../../../src/primitives/FeeMarket/index.js"
			);

			expect(typeof State.getBlobBaseFee).toBe("function");
		});
	});
});

```
