---
title: TransactionStream Tests
description: Test examples for transaction streaming service with pending, confirmed, and tracking functionality.
---

## TransactionStreamError creation

Shows error construction with message, cause, and context.

```typescript
import { TransactionStreamError } from "voltaire-effect/transaction";

const error = new TransactionStreamError("test error");
expect(error.message).toBe("test error");
expect(error._tag).toBe("TransactionStreamError");

const errorWithCause = new TransactionStreamError("test error", {
  cause: new Error("underlying"),
});
expect(errorWithCause.cause).toBeDefined();

const errorWithContext = new TransactionStreamError("test error", {
  context: { txHash: "0x123", confirmations: 3 },
});
expect(error._tag).toBe("TransactionStreamError");
```

## TransactionStream layer provides service

Demonstrates the TransactionStream layer providing TransactionStreamService.

```typescript
import * as Effect from "effect/Effect";
import * as Layer from "effect/Layer";
import { TransportService } from "voltaire-effect";
import { TransactionStream, TransactionStreamService } from "voltaire-effect/transaction";

const mockTransport = {
  request: <T>(_method: string, _params?: unknown[]) => Effect.succeed("0x1" as T),
};

const TestTransportLayer = Layer.succeed(TransportService, mockTransport);
const TestTransactionStreamLayer = Layer.provide(TransactionStream, TestTransportLayer);

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  expect(txStream.watchPending).toBeDefined();
  expect(txStream.watchConfirmed).toBeDefined();
  expect(txStream.track).toBeDefined();
}).pipe(Effect.provide(TestTransactionStreamLayer));

await Effect.runPromise(program);
```

## watchPending returns a stream

Shows creating a stream of pending transactions.

```typescript
import * as Effect from "effect/Effect";
import * as Layer from "effect/Layer";
import { TransportService } from "voltaire-effect";
import { TransactionStream, TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.watchPending();
  expect(stream).toBeDefined();
}).pipe(Effect.provide(TestTransactionStreamLayer));
```

## watchPending with filter

Demonstrates filtering pending transactions by address.

```typescript
import * as Effect from "effect/Effect";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.watchPending({
    filter: { to: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" },
  });
  expect(stream).toBeDefined();
});
```

## watchConfirmed with custom confirmations

Shows watching for confirmed transactions with different confirmation counts.

```typescript
import * as Effect from "effect/Effect";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream1 = txStream.watchConfirmed({ confirmations: 1 });
  const stream12 = txStream.watchConfirmed({ confirmations: 12 });
  expect(stream1).toBeDefined();
  expect(stream12).toBeDefined();
});
```

## track returns transaction status stream

Demonstrates tracking a specific transaction by hash.

```typescript
import * as Effect from "effect/Effect";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.track(
    "0x1234567890123456789012345678901234567890123456789012345678901234",
    { confirmations: 6 },
  );
  expect(stream).toBeDefined();
});
```

## Emits dropped event when transaction disappears

Shows how the stream detects when a pending transaction is dropped or replaced.

```typescript
import * as Effect from "effect/Effect";
import * as Stream from "effect/Stream";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.track(
    "0x1234567890123456789012345678901234567890123456789012345678901234",
    { confirmations: 1, pollingInterval: 1 },
  );
  const events = yield* Stream.take(stream, 2).pipe(Stream.runCollect);
  expect(events.length).toBe(2);
  const eventArray = Array.from(events);
  expect(eventArray[0].type).toBe("pending");
  expect(eventArray[1].type).toBe("dropped");
});
```

## Handles successful transaction (status 0x1)

Demonstrates confirmed event with successful receipt status.

```typescript
import * as Effect from "effect/Effect";
import * as Stream from "effect/Stream";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.track(txHash, { confirmations: 1 });
  const events = yield* Stream.take(stream, 1).pipe(Stream.runCollect);
  const event = Array.from(events)[0];
  expect(event.type).toBe("confirmed");
  if (event.type === "confirmed") {
    expect(event.transaction.receipt.status).toBe(1);
  }
});
```

## Handles reverted transaction (status 0x0)

Shows detecting reverted transactions via receipt status.

```typescript
import * as Effect from "effect/Effect";
import * as Stream from "effect/Stream";
import { TransactionStreamService } from "voltaire-effect/transaction";

const program = Effect.gen(function* () {
  const txStream = yield* TransactionStreamService;
  const stream = txStream.track(txHash, { confirmations: 1 });
  const events = yield* Stream.take(stream, 1).pipe(Stream.runCollect);
  const event = Array.from(events)[0];
  expect(event.type).toBe("confirmed");
  if (event.type === "confirmed") {
    expect(event.transaction.receipt.status).toBe(0);  // reverted
  }
});
```
