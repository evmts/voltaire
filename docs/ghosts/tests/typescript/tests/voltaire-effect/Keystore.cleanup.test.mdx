---
title: Keystore Cleanup Tests
description: Test examples for verifying memory cleanup of decrypted keys in Keystore operations.
---

## Zeroes decrypted key after normal use

Demonstrates that private keys are zeroed after withDecryptedKey completes normally.

```typescript
import * as Effect from "effect/Effect";
import * as Keystore from "voltaire-effect/crypto/Keystore";

const testPrivateKey = new Uint8Array([
  0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
  0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
  0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
  0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
]);
const testPassword = "test-password-123";

const encrypted = await Effect.runPromise(
  Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  }),
);

let capturedKey: Uint8Array | null = null;

await Effect.runPromise(
  Keystore.withDecryptedKey(encrypted, testPassword, (key) =>
    Effect.sync(() => {
      capturedKey = key;
      expect(key).toEqual(testPrivateKey);
    }),
  ),
);

expect(capturedKey).not.toBeNull();
expect((capturedKey as Uint8Array).every((b) => b === 0)).toBe(true);
```

## Zeroes decrypted key even when use effect fails

Shows that keys are cleaned up even on error paths.

```typescript
import * as Effect from "effect/Effect";
import * as Exit from "effect/Exit";
import * as Keystore from "voltaire-effect/crypto/Keystore";

const encrypted = await Effect.runPromise(
  Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  }),
);

let capturedKey: Uint8Array | null = null;

const exit = await Effect.runPromiseExit(
  Keystore.withDecryptedKey(encrypted, testPassword, (key) =>
    Effect.sync(() => {
      capturedKey = key;
      throw new Error("deliberate test error");
    }),
  ),
);

expect(Exit.isFailure(exit)).toBe(true);
expect(capturedKey).not.toBeNull();
expect((capturedKey as Uint8Array).every((b) => b === 0)).toBe(true);
```

## Does not call use when password is wrong

Demonstrates that incorrect passwords fail before accessing the key.

```typescript
import * as Effect from "effect/Effect";
import * as Exit from "effect/Exit";
import * as Keystore from "voltaire-effect/crypto/Keystore";

const encrypted = await Effect.runPromise(
  Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  }),
);

let useCalled = false;

const exit = await Effect.runPromiseExit(
  Keystore.withDecryptedKey(encrypted, "wrong-password", (_key) =>
    Effect.sync(() => {
      useCalled = true;
    }),
  ),
);

expect(Exit.isFailure(exit)).toBe(true);
expect(useCalled).toBe(false);
```
