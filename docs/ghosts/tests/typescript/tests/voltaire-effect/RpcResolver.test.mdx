---
title: RpcResolver Tests
description: Test examples for RpcResolver showing single requests, batch encoding, and error handling.
---

## Single Request

Uses direct transport.request for single request.

```typescript
import { describe, expect, it, vi } from "@effect/vitest"
import * as Effect from "effect/Effect"
import { EthBlockNumber } from "voltaire-effect"
import { makeRpcResolver } from "voltaire-effect"

describe("RpcResolver", () => {
  describe("single request", () => {
    it("uses direct transport.request for single request", async () => {
      const transport = { request: vi.fn().mockReturnValue(Effect.succeed("0x123")) }
      const resolver = makeRpcResolver(transport)

      const result = await Effect.runPromise(
        Effect.request(new EthBlockNumber({}), resolver as any) as any
      )

      expect(result).toBe("0x123")
      expect(transport.request).toHaveBeenCalledWith("eth_blockNumber", [])
      expect(transport.request).toHaveBeenCalledTimes(1)
    })
  })
})
```

## Batch Request Encoding

Encodes multiple requests as JSON-RPC batch.

```typescript
import { describe, expect, it, vi } from "@effect/vitest"
import * as Effect from "effect/Effect"
import { EthBlockNumber, EthGetBalance } from "voltaire-effect"
import { makeRpcResolver } from "voltaire-effect"

describe("batch request encoding", () => {
  it("encodes multiple requests as JSON-RPC batch", async () => {
    const transport = {
      request: vi.fn().mockReturnValue(
        Effect.succeed([
          { jsonrpc: "2.0", id: 0, result: "0x100" },
          { jsonrpc: "2.0", id: 1, result: "0x200" },
        ])
      ),
    }
    const resolver = makeRpcResolver(transport)

    const [blockNumber, balance] = await Effect.runPromise(
      Effect.all(
        [
          Effect.request(new EthBlockNumber({}), resolver as any),
          Effect.request(new EthGetBalance({ address: "0xabc", blockTag: "latest" }), resolver as any),
        ],
        { batching: true }
      ) as any
    )

    expect(blockNumber).toBe("0x100")
    expect(balance).toBe("0x200")
    expect(transport.request).toHaveBeenCalledWith("__batch__", [
      { jsonrpc: "2.0", id: 0, method: "eth_blockNumber", params: [] },
      { jsonrpc: "2.0", id: 1, method: "eth_getBalance", params: ["0xabc", "latest"] },
    ])
  })
})
```

## Missing Response ID Error

Returns TransportError -32603 for missing response id.

```typescript
import { describe, expect, it, vi } from "@effect/vitest"
import * as Effect from "effect/Effect"
import { TransportError } from "voltaire-effect"
import { EthBlockNumber, EthGetBalance } from "voltaire-effect"
import { makeRpcResolver } from "voltaire-effect"

describe("batch error handling", () => {
  it("returns TransportError -32603 for missing response id", async () => {
    const transport = {
      request: vi.fn().mockReturnValue(
        Effect.succeed([{ jsonrpc: "2.0", id: 0, result: "0x100" }])
      ),
    }
    const resolver = makeRpcResolver(transport)

    const results = await Effect.runPromise(
      Effect.all(
        [
          (Effect.request(new EthBlockNumber({}), resolver as any) as any).pipe(Effect.either),
          (Effect.request(new EthGetBalance({ address: "0xabc", blockTag: "latest" }), resolver as any) as any).pipe(Effect.either),
        ],
        { batching: true }
      )
    )

    expect(results[0]._tag).toBe("Right")
    expect(results[1]._tag).toBe("Left")
    if (results[1]._tag === "Left") {
      const err = results[1].left as TransportError
      expect(err.code).toBe(-32603)
      expect(err.message).toContain("Missing response for request id 1")
    }
  })
})
```

## Per-Request Errors

Maps response.error to TransportError with code/message.

```typescript
import { describe, expect, it, vi } from "@effect/vitest"
import * as Effect from "effect/Effect"
import { TransportError } from "voltaire-effect"
import { EthBlockNumber, EthGetBalance } from "voltaire-effect"
import { makeRpcResolver } from "voltaire-effect"

describe("per-request errors", () => {
  it("maps response.error to TransportError with code/message", async () => {
    const transport = {
      request: vi.fn().mockReturnValue(
        Effect.succeed([
          { jsonrpc: "2.0", id: 0, result: "0x100" },
          { jsonrpc: "2.0", id: 1, error: { code: -32602, message: "invalid params", data: { foo: "bar" } } },
        ])
      ),
    }
    const resolver = makeRpcResolver(transport)

    const results = await Effect.runPromise(
      Effect.all(
        [
          (Effect.request(new EthBlockNumber({}), resolver as any) as any).pipe(Effect.either),
          (Effect.request(new EthGetBalance({ address: "0xabc", blockTag: "latest" }), resolver as any) as any).pipe(Effect.either),
        ],
        { batching: true }
      )
    )

    expect(results[0]._tag).toBe("Right")
    expect(results[1]._tag).toBe("Left")
    if (results[1]._tag === "Left") {
      const err = results[1].left as TransportError
      expect(err.code).toBe(-32602)
      expect(err.message).toBe("invalid params")
      expect(err.data).toEqual({ foo: "bar" })
    }
  })
})
```

## Request Type Encoding

Encodes various RPC request types correctly.

```typescript
import { describe, expect, it, vi } from "@effect/vitest"
import * as Effect from "effect/Effect"
import {
  EthBlockNumber,
  EthGetBalance,
  EthCall,
  EthGetLogs,
  GenericRpcRequest,
} from "voltaire-effect"
import { makeRpcResolver } from "voltaire-effect"

describe("request type encoding", () => {
  it("encodes EthBlockNumber", async () => {
    const transport = { request: vi.fn().mockReturnValue(Effect.succeed("0x1")) }
    const resolver = makeRpcResolver(transport)

    await Effect.runPromise(Effect.request(new EthBlockNumber({}), resolver as any) as any)

    expect(transport.request).toHaveBeenCalledWith("eth_blockNumber", [])
  })

  it("encodes EthGetBalance", async () => {
    const transport = { request: vi.fn().mockReturnValue(Effect.succeed("0x1")) }
    const resolver = makeRpcResolver(transport)

    await Effect.runPromise(
      Effect.request(new EthGetBalance({ address: "0xabc", blockTag: "pending" }), resolver as any) as any
    )

    expect(transport.request).toHaveBeenCalledWith("eth_getBalance", ["0xabc", "pending"])
  })

  it("encodes EthCall with all fields", async () => {
    const transport = { request: vi.fn().mockReturnValue(Effect.succeed("0x")) }
    const resolver = makeRpcResolver(transport)

    await Effect.runPromise(
      Effect.request(
        new EthCall({
          to: "0xcontract",
          data: "0xabcd",
          from: "0xsender",
          gas: "0x5208",
          gasPrice: "0x3b9aca00",
          value: "0x0",
          blockTag: "latest",
        }),
        resolver as any
      ) as any
    )

    expect(transport.request).toHaveBeenCalledWith("eth_call", [
      { to: "0xcontract", data: "0xabcd", from: "0xsender", gas: "0x5208", gasPrice: "0x3b9aca00", value: "0x0" },
      "latest",
    ])
  })
})
```
