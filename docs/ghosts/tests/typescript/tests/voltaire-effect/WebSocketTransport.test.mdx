---
title: WebSocketTransport Tests
description: Test examples for WebSocketTransport showing WebSocket-based JSON-RPC transport.
---

## WebSocketTransport accepts string URL configuration

The transport can be configured with a simple URL string.

```typescript
import { Layer } from 'effect'
import { WebSocketTransport } from 'voltaire-effect'

const layer = WebSocketTransport("wss://test.example.com")
expect(Layer.isLayer(layer)).toBe(true)
```

## WebSocketTransport accepts object configuration with all options

Full configuration options include timeout, protocols, reconnect, and keepAlive.

```typescript
import { Layer } from 'effect'
import { WebSocketTransport } from 'voltaire-effect'

const layer = WebSocketTransport({
  url: "wss://test.example.com",
  timeout: 60000,
  protocols: ["graphql-ws"],
  reconnect: {
    maxAttempts: 5,
    delay: 500,
    maxDelay: 10000,
    multiplier: 1.5,
  },
  keepAlive: 30000,
})
expect(Layer.isLayer(layer)).toBe(true)
```

## WebSocketTransport fails with -32603 when disconnected and reconnect disabled

Requests fail immediately when the WebSocket is disconnected and reconnect is disabled.

```typescript
import { Effect, Layer } from 'effect'
import { TransportError, TransportService, WebSocketTransport, WebSocketConstructorGlobal } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  yield* Effect.sleep(10)
  // WebSocket disconnects...
  yield* Effect.sleep(10)

  return yield* transport.request<string>("eth_blockNumber")
}).pipe(
  Effect.provide(
    Layer.provide(
      WebSocketTransport({ url: "ws://test", reconnect: false }),
      WebSocketConstructorGlobal,
    ),
  ),
  Effect.scoped,
)

const exit = await Effect.runPromiseExit(program)

expect(exit._tag).toBe("Failure")
if (exit._tag === "Failure" && exit.cause._tag === "Fail") {
  expect(exit.cause.error).toBeInstanceOf(TransportError)
  expect(exit.cause.error.input.code).toBe(-32603)
}
```

## WebSocketTransport fails with timeout when no response received

Requests time out if no response is received within the timeout period.

```typescript
import { Effect, Layer } from 'effect'
import { TransportError, TransportService, WebSocketTransport } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber")
}).pipe(
  Effect.provide(
    Layer.provide(
      WebSocketTransport({ url: "ws://test", timeout: 50, reconnect: false }),
      WebSocketConstructorGlobal,
    ),
  ),
  Effect.scoped,
)

const exit = await Effect.runPromiseExit(program)

expect(exit._tag).toBe("Failure")
if (exit._tag === "Failure" && exit.cause._tag === "Fail") {
  expect(exit.cause.error).toBeInstanceOf(TransportError)
  expect(exit.cause.error.message).toContain("timeout")
}
```

## WebSocketTransport propagates error code, message, and data from JSON-RPC response

JSON-RPC error responses are properly converted to TransportError.

```typescript
import { Effect, Layer } from 'effect'
import { TransportError, TransportService, WebSocketTransport } from 'voltaire-effect'

// Mock WebSocket sends JSON-RPC error response
const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_getBalance", ["0x123"])
}).pipe(Effect.provide(layer), Effect.scoped)

const exit = await Effect.runPromiseExit(program)

expect(exit._tag).toBe("Failure")
if (exit._tag === "Failure" && exit.cause._tag === "Fail") {
  expect(exit.cause.error).toBeInstanceOf(TransportError)
  expect(exit.cause.error.input.code).toBe(-32602)
  expect(exit.cause.error.message).toBe("Invalid params")
  expect(exit.cause.error.data).toEqual({ hint: "bad address" })
}
```

## WebSocketTransport matches responses to requests by ID

Responses are correctly matched to requests even when received out of order.

```typescript
import { Effect, Fiber, Layer } from 'effect'
import { TransportService, WebSocketTransport } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  const fiber1 = yield* Effect.fork(transport.request<string>("eth_blockNumber"))
  const fiber2 = yield* Effect.fork(transport.request<string>("eth_chainId"))

  yield* Effect.sleep(20)
  // Mock sends responses out of order...

  const [result1, result2] = yield* Effect.all([
    Fiber.join(fiber1),
    Fiber.join(fiber2),
  ])
  return { result1, result2 }
}).pipe(Effect.provide(layer), Effect.scoped)

const { result1, result2 } = await Effect.runPromise(program)

expect(result1).toBe("0xabc") // eth_blockNumber response
expect(result2).toBe("0x1")   // eth_chainId response
```

## WebSocketTransport queues requests during reconnection when enabled

With reconnect enabled, requests are queued while reconnecting.

```typescript
import { Effect, Layer } from 'effect'
import { TransportService, WebSocketTransport, WebSocketConstructorGlobal } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber")
}).pipe(
  Effect.provide(
    Layer.provide(
      WebSocketTransport({
        url: "ws://test",
        reconnect: { maxAttempts: 3, delay: 10 },
      }),
      WebSocketConstructorGlobal,
    ),
  ),
  Effect.scoped,
)

const result = await Effect.runPromise(program)
expect(result).toBe("0x1")
```

## WebSocketTransport sends request and receives response

Basic request/response flow works correctly.

```typescript
import { Effect, Layer } from 'effect'
import { TransportService, WebSocketTransport, WebSocketConstructorGlobal } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber")
}).pipe(
  Effect.provide(
    Layer.provide(
      WebSocketTransport({ url: "ws://test", reconnect: false }),
      WebSocketConstructorGlobal,
    ),
  ),
  Effect.scoped,
)

const result = await Effect.runPromise(program)
expect(result).toBe("0x123abc")
```
