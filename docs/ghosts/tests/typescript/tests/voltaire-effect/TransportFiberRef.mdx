---
title: TransportFiberRef Tests
description: Test examples for Transport FiberRef overrides showing per-request timeout, retry, and cache configuration.
---

## Scopes timeout overrides per request

Demonstrates using withTimeout to override the default timeout for a specific request.

```typescript
import { Effect } from 'effect'
import { TransportService, HttpTransport, withTimeout } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  const [defaultResult, overrideResult] = yield* Effect.all(
    [
      transport.request<string>("eth_chainId", []).pipe(Effect.either),
      transport
        .request<string>("eth_chainId", [])
        .pipe(withTimeout(50), Effect.either),
    ],
    { concurrency: "unbounded" },
  )
  return { defaultResult, overrideResult }
}).pipe(
  Effect.provide(
    HttpTransport({
      url: "https://eth.example.com",
      timeout: 5, // Very short default timeout
      retries: 0,
    }),
  ),
)

const { defaultResult, overrideResult } = await Effect.runPromise(program)
// defaultResult fails due to short timeout
expect(defaultResult._tag).toBe("Left")
// overrideResult succeeds with longer timeout
expect(overrideResult._tag).toBe("Right")
```

## Overrides retry count per request

Shows using withRetries to add retries to a specific request.

```typescript
import { Effect } from 'effect'
import { TransportService, HttpTransport, withRetries } from 'voltaire-effect'

const fetchMock = vi
  .fn()
  .mockResolvedValueOnce({
    ok: true,
    json: async () => ({
      jsonrpc: "2.0",
      id: 1,
      error: { code: -32603, message: "boom" },
    }),
  })
  .mockResolvedValueOnce({
    ok: true,
    json: async () => ({ jsonrpc: "2.0", id: 2, result: "0x1" }),
  })

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_chainId", [])
}).pipe(
  withRetries(1), // Allow one retry
  Effect.provide(
    HttpTransport({
      url: "https://eth.example.com",
      retries: 0, // Default: no retries
    }),
  ),
)

const result = await Effect.runPromise(program)
expect(result).toBe("0x1")
expect(fetchMock).toHaveBeenCalledTimes(2) // Initial + 1 retry
```

## Scopes cache disable without leaking to other fibers

Demonstrates using withoutCache to bypass the deduplication cache for specific requests.

```typescript
import { Effect, Layer } from 'effect'
import { TransportService, DeduplicatedTransport, withoutCache } from 'voltaire-effect'

let callCount = 0
const baseTransport = Layer.succeed(TransportService, {
  request: <T>() =>
    Effect.sync(() => {
      callCount += 1
      return "0x1" as T
    }),
})

const transport = DeduplicatedTransport(baseTransport, { ttl: 1000 })

const program = Effect.gen(function* () {
  const svc = yield* TransportService
  yield* Effect.all(
    [
      svc.request<string>("eth_chainId").pipe(withoutCache), // Bypasses cache
      svc.request<string>("eth_chainId"), // Uses cache
      svc.request<string>("eth_chainId"), // Uses cache
    ],
    { concurrency: "unbounded" },
  )
  return callCount
}).pipe(Effect.provide(transport), Effect.scoped)

const count = await Effect.runPromise(program)
// withoutCache request + one cached request = 2 calls
expect(count).toBe(2)
```
