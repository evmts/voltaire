---
title: prepareAuthorization Tests
description: Test examples for prepareAuthorization showing EIP-7702 authorization preparation with chain ID and nonce fetching.
---

## Prepares authorization with fetched chain ID and nonce

Demonstrates preparing an authorization by automatically fetching chain ID and nonce from the provider.

```typescript
import { Effect, Layer } from 'effect'
import { prepareAuthorization } from 'voltaire-effect'
import { AccountService } from 'voltaire-effect'
import { ProviderService } from 'voltaire-effect'

const program = prepareAuthorization({
  contractAddress: "0x1234567890123456789012345678901234567890",
})

const result = await Effect.runPromise(Effect.provide(program, TestLayers))

expect(result.chainId).toBe(1n)
expect(result.nonce).toBe(5n)
expect(result.address).toBe("0x1234567890123456789012345678901234567890")
```

## Uses provided chain ID

Shows overriding the fetched chain ID with a custom value.

```typescript
import { Effect } from 'effect'
import { prepareAuthorization } from 'voltaire-effect'

const program = prepareAuthorization({
  contractAddress: "0x1234567890123456789012345678901234567890",
  chainId: 137n,
})

const result = await Effect.runPromise(Effect.provide(program, TestLayers))

expect(result.chainId).toBe(137n)
```

## Uses provided nonce without fetching

Demonstrates skipping nonce fetch when a custom nonce is provided.

```typescript
import { Effect } from 'effect'
import { prepareAuthorization } from 'voltaire-effect'

const program = prepareAuthorization({
  contractAddress: "0x1234567890123456789012345678901234567890",
  nonce: 42n,
})

const result = await Effect.runPromise(Effect.provide(program, TestLayers))

expect(result.nonce).toBe(42n)
```

## Converts AddressType contract address to hex

Shows that branded AddressType is automatically converted to hex string.

```typescript
import { Effect } from 'effect'
import { prepareAuthorization } from 'voltaire-effect'
import type { BrandedAddress } from '@tevm/voltaire'

type AddressType = BrandedAddress.AddressType
const contractAddress = new Uint8Array(20).fill(0x12) as AddressType

const program = prepareAuthorization({ contractAddress })

const result = await Effect.runPromise(Effect.provide(program, TestLayers))

expect((result.address as string).toLowerCase()).toBe(
  "0x1212121212121212121212121212121212121212",
)
```

## Handles provider errors

Demonstrates proper error handling when provider calls fail.

```typescript
import { Effect, Layer } from 'effect'
import { prepareAuthorization } from 'voltaire-effect'
import { ProviderService } from 'voltaire-effect'
import { TransportError } from 'voltaire-effect'

const providerWithError = {
  ...mockProvider,
  getChainId: () =>
    Effect.fail(
      new TransportError({ code: -32000, message: "Network error" }),
    ),
}

const program = prepareAuthorization({
  contractAddress: "0x1234567890123456789012345678901234567890",
})

const result = await Effect.runPromiseExit(
  Effect.provide(program, customLayers),
)

expect(result._tag).toBe("Failure")
```
