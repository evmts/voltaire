---
title: TransportInterceptor Tests
description: Test examples for TransportInterceptor and DeduplicatedTransport showing request/response interception and deduplication.
---

## withRequestInterceptor - Calls interceptor before request

Demonstrates intercepting requests before they are sent.

```typescript
import { Effect } from 'effect'
import { 
  TransportService, 
  InterceptedTransport, 
  TestTransport, 
  withRequestInterceptor 
} from 'voltaire-effect'

const calls: string[] = []

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    InterceptedTransport(TestTransport({ eth_blockNumber: "0x100" })),
  ),
  withRequestInterceptor((req) =>
    Effect.sync(() => {
      calls.push(`request:${req.method}`)
      return req
    }),
  ),
)

const result = await Effect.runPromise(program)
expect(result).toBe("0x100")
expect(calls).toContain("request:eth_blockNumber")
```

## withResponseInterceptor - Calls interceptor after successful request

Shows intercepting responses after they are received.

```typescript
import { Effect } from 'effect'
import { 
  TransportService, 
  InterceptedTransport, 
  TestTransport, 
  withResponseInterceptor 
} from 'voltaire-effect'

const calls: Array<{ method: string; result: unknown }> = []

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    InterceptedTransport(TestTransport({ eth_blockNumber: "0x200" })),
  ),
  withResponseInterceptor((res) =>
    Effect.sync(() => {
      calls.push({ method: res.method, result: res.result })
      return res
    }),
  ),
)

const result = await Effect.runPromise(program)
expect(result).toBe("0x200")
expect(calls[0].method).toBe("eth_blockNumber")
expect(calls[0].result).toBe("0x200")
```

## withErrorInterceptor - Calls interceptor on error

Demonstrates intercepting and logging errors.

```typescript
import { Effect } from 'effect'
import { 
  TransportService, 
  InterceptedTransport, 
  TestTransport, 
  TransportError,
  withErrorInterceptor 
} from 'voltaire-effect'

const errors: Array<{ method: string; code: number }> = []

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_call", [])
}).pipe(
  Effect.provide(
    InterceptedTransport(
      TestTransport({
        eth_call: new TransportError({
          code: -32000,
          message: "execution reverted",
        }),
      }),
    ),
  ),
  withErrorInterceptor((err) =>
    Effect.sync(() => {
      errors.push({ method: err.method, code: err.error.code })
    }),
  ),
)

const exit = await Effect.runPromiseExit(program)
expect(exit._tag).toBe("Failure")
expect(errors[0].method).toBe("eth_call")
expect(errors[0].code).toBe(-32000)
```

## withInterceptors - Applies all interceptors

Shows using the combined interceptor helper.

```typescript
import { Effect } from 'effect'
import { 
  TransportService, 
  InterceptedTransport, 
  TestTransport, 
  withInterceptors 
} from 'voltaire-effect'

const calls: string[] = []

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    InterceptedTransport(TestTransport({ eth_blockNumber: "0x1" })),
  ),
  withInterceptors({
    onRequest: (req) =>
      Effect.sync(() => {
        calls.push("request")
        return req
      }),
    onResponse: (res) =>
      Effect.sync(() => {
        calls.push("response")
        return res
      }),
  }),
)

await Effect.runPromise(program)
expect(calls).toEqual(["request", "response"])
```

## DeduplicatedTransport - Deduplicates identical concurrent requests

Demonstrates request deduplication for concurrent identical requests.

```typescript
import { Effect, Fiber } from 'effect'
import { TransportService, DeduplicatedTransport, TestTransport } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  // Fork multiple concurrent identical requests
  const fiber1 = yield* Effect.fork(
    transport.request<string>("eth_blockNumber", []),
  )
  const fiber2 = yield* Effect.fork(
    transport.request<string>("eth_blockNumber", []),
  )

  const r1 = yield* Fiber.join(fiber1)
  const r2 = yield* Fiber.join(fiber2)

  return [r1, r2]
}).pipe(
  Effect.provide(
    DeduplicatedTransport(TestTransport({ eth_blockNumber: "0x100" })),
  ),
)

const [r1, r2] = await Effect.runPromise(program)
expect(r1).toBe("0x100")
expect(r2).toBe("0x100")
// Both requests share the same underlying call
```

## DeduplicatedTransport - Does not deduplicate different methods

Shows that different methods are not deduplicated.

```typescript
import { Effect, Fiber } from 'effect'
import { TransportService, DeduplicatedTransport, TestTransport } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  const fiber1 = yield* Effect.fork(
    transport.request<string>("eth_blockNumber", []),
  )
  const fiber2 = yield* Effect.fork(
    transport.request<string>("eth_chainId", []),
  )

  const r1 = yield* Fiber.join(fiber1)
  const r2 = yield* Fiber.join(fiber2)

  return [r1, r2]
}).pipe(
  Effect.provide(
    DeduplicatedTransport(
      TestTransport({
        eth_blockNumber: "0x100",
        eth_chainId: "0x1",
      }),
    ),
  ),
)

const [r1, r2] = await Effect.runPromise(program)
expect(r1).toBe("0x100")
expect(r2).toBe("0x1")
```

## DeduplicatedTransport - Respects excludeMethods config

Demonstrates excluding specific methods from deduplication.

```typescript
import { Effect, Fiber } from 'effect'
import { TransportService, DeduplicatedTransport, TestTransport } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  // eth_sendRawTransaction should not be deduplicated
  const fiber1 = yield* Effect.fork(
    transport.request<string>("eth_sendRawTransaction", ["0x..."]),
  )
  const fiber2 = yield* Effect.fork(
    transport.request<string>("eth_sendRawTransaction", ["0x..."]),
  )

  const r1 = yield* Fiber.join(fiber1)
  const r2 = yield* Fiber.join(fiber2)

  return [r1, r2]
}).pipe(
  Effect.provide(
    DeduplicatedTransport(
      TestTransport({ eth_sendRawTransaction: "0xhash" }),
      { excludeMethods: ["eth_sendRawTransaction"] },
    ),
  ),
)

// Both requests execute independently
```

## DeduplicatedTransport - Propagates errors to all waiting requests

Shows that errors are propagated to all requests sharing a deduplicated call.

```typescript
import { Effect, Fiber } from 'effect'
import { TransportService, DeduplicatedTransport, TestTransport, TransportError } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const transport = yield* TransportService

  const fiber1 = yield* Effect.fork(
    transport.request<string>("eth_call", []),
  )
  const fiber2 = yield* Effect.fork(
    transport.request<string>("eth_call", []),
  )

  const exit1 = yield* Fiber.await(fiber1)
  const exit2 = yield* Fiber.await(fiber2)

  return [exit1._tag, exit2._tag]
}).pipe(
  Effect.provide(
    DeduplicatedTransport(
      TestTransport({
        eth_call: new TransportError({ code: -32000, message: "reverted" }),
      }),
    ),
  ),
)

const [e1, e2] = await Effect.runPromise(program)
expect(e1).toBe("Failure")
expect(e2).toBe("Failure")
```
