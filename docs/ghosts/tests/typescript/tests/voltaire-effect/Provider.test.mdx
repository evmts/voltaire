---
title: Provider Tests
description: Test examples for ProviderService showing Ethereum JSON-RPC operations.
---

## getBlockNumber returns block number as bigint

The getBlockNumber method returns the current block number as a bigint.

```typescript
import { Effect, Layer } from 'effect'
import { Provider, ProviderService } from 'voltaire-effect'
import { TransportService } from 'voltaire-effect'

const mockTransport = (responses: Record<string, unknown>) =>
  Layer.succeed(TransportService, {
    request: <T>(method: string) =>
      Effect.try({
        try: () => {
          if (method in responses) return responses[method] as T
          throw new Error(`Unknown method: ${method}`)
        },
        catch: (e) => new TransportError({ code: -32603, message: (e as Error).message }),
      }),
  })

const transport = mockTransport({ eth_blockNumber: "0x10" })
const layer = Provider.pipe(Layer.provide(transport))

const result = await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getBlockNumber()
  }).pipe(Effect.provide(layer)),
)

expect(result).toBe(16n)
```

## getBalance returns balance as bigint

The getBalance method returns an account's ETH balance as a bigint.

```typescript
import { Effect, Layer } from 'effect'
import { Address } from 'voltaire'
import { Provider, ProviderService } from 'voltaire-effect'

const transport = mockTransport({ eth_getBalance: "0xde0b6b3a7640000" })
const layer = Provider.pipe(Layer.provide(transport))

const result = await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getBalance("0x1234567890123456789012345678901234567890")
  }).pipe(Effect.provide(layer)),
)

expect(result).toBe(1000000000000000000n)
```

## getBalance accepts AddressType branded type

The provider methods accept branded Address types for type safety.

```typescript
import { Effect, Layer } from 'effect'
import { Address } from 'voltaire'
import { Provider, ProviderService } from 'voltaire-effect'

const transport = mockTransport({ eth_getBalance: "0xde0b6b3a7640000" })
const layer = Provider.pipe(Layer.provide(transport))
const addr = Address("0x1234567890123456789012345678901234567890")

const result = await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getBalance(addr)
  }).pipe(Effect.provide(layer)),
)

expect(result).toBe(1000000000000000000n)
```

## getBlock returns block by tag

The getBlock method fetches block data by block tag or number.

```typescript
import { Effect, Layer } from 'effect'
import { Provider, ProviderService } from 'voltaire-effect'

const mockBlock = {
  number: "0x10",
  hash: "0xabc",
  parentHash: "0xdef",
  transactions: [],
}

const transport = mockTransport({ eth_getBlockByNumber: mockBlock })
const layer = Provider.pipe(Layer.provide(transport))

const result = await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getBlock({ blockTag: "latest" })
  }).pipe(Effect.provide(layer)),
)

expect(result.number).toBe("0x10")
expect(result.hash).toBe("0xabc")
```

## getLogs formats topics correctly

The getLogs method properly formats topic filters for event queries.

```typescript
import { Effect, Layer } from 'effect'
import { Provider, ProviderService } from 'voltaire-effect'

let capturedParams: unknown[] = []
const mockTransport = Layer.succeed(TransportService, {
  request: <T>(method: string, params: unknown[] = []) =>
    Effect.gen(function* () {
      if (method === "eth_getLogs") {
        capturedParams = params
        return [] as T
      }
      return [] as T
    }),
})

const layer = Provider.pipe(Layer.provide(mockTransport))
const topic = "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"

await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getLogs({ topics: [topic] })
  }).pipe(Effect.provide(layer)),
)

const filter = capturedParams[0] as Record<string, unknown>
expect(filter.topics).toEqual([topic])
```

## estimateBlobGas estimates blob gas from blob count

The estimateBlobGas helper calculates gas for blob transactions.

```typescript
import { estimateBlobGas } from 'voltaire-effect'
import { InvalidBlobCountError } from 'voltaire/Blob'

expect(estimateBlobGas(3)).toBe(393216n)
expect(() => estimateBlobGas(7)).toThrow(InvalidBlobCountError)
```

## getTransactionConfirmations returns confirmations for mined transaction

Calculates the number of block confirmations for a mined transaction.

```typescript
import { Effect, Layer } from 'effect'
import { Provider, ProviderService } from 'voltaire-effect'

const mockReceipt = {
  transactionHash: "0xabc",
  blockNumber: "0x64", // block 100
  status: "0x1",
}

const mockTransport = {
  eth_getTransactionReceipt: () => mockReceipt,
  eth_blockNumber: () => "0x69", // block 105
}

const result = await Effect.runPromise(
  Effect.gen(function* () {
    const provider = yield* ProviderService
    return yield* provider.getTransactionConfirmations("0xabc")
  }).pipe(Effect.provide(layer)),
)

expect(result).toBe(6n) // 105 - 100 + 1 = 6 confirmations
```
