---
title: HttpTransportHooks Tests
description: Test examples for HTTP transport request/response interceptor hooks and FiberRef overrides.
---

## Applies request/response hooks with FiberRef overrides

Demonstrates chaining config-level and FiberRef-level request/response interceptors with proper execution order.

```typescript
import { FetchHttpClient } from "@effect/platform";
import * as HttpClient from "@effect/platform/HttpClient";
import { describe, expect, it, vi } from "@effect/vitest";
import * as Effect from "effect/Effect";
import * as Layer from "effect/Layer";
import {
  HttpTransport,
  TransportService,
  withRequestInterceptor,
  withResponseInterceptor,
} from "voltaire-effect";

const program = Effect.gen(function* () {
  const transport = yield* TransportService;
  return yield* transport.request<string>("eth_blockNumber", []);
}).pipe(
  Effect.provide(
    HttpTransport({
      url: "https://eth.example.com",
      onRequest: (req) =>
        Effect.sync(() => {
          return { ...req, method: "eth_chainId", params: ["0x1"] };
        }),
      onResponse: (res) =>
        Effect.sync(() => {
          return { ...res, result: "0x2" } as typeof res;
        }),
    }),
  ),
  withRequestInterceptor((req) =>
    Effect.sync(() => {
      return { ...req, method: "eth_gasPrice", params: [] };
    }),
  ),
  withResponseInterceptor((res) =>
    Effect.sync(() => {
      return { ...res, result: "0x3" } as typeof res;
    }),
  ),
);

const result = await Effect.runPromise(program);
expect(result).toBe("0x3");
```

## Passes fetchOptions and custom fetch

Shows how to provide a custom fetch function with additional options like credentials and headers.

```typescript
import { FetchHttpClient } from "@effect/platform";
import * as Effect from "effect/Effect";
import { HttpTransport, TransportService } from "voltaire-effect";

const customFetch = Object.assign(
  async (_url: string, _init?: RequestInit) =>
    new Response(
      JSON.stringify({ jsonrpc: "2.0", id: 1, result: "0x1" }),
      { status: 200, headers: { "Content-Type": "application/json" } },
    ),
  { preconnect: () => {} },
) as typeof fetch;

const program = Effect.gen(function* () {
  const transport = yield* TransportService;
  return yield* transport.request<string>("eth_chainId", []);
}).pipe(
  Effect.provide(
    HttpTransport({
      url: "https://eth.example.com",
      headers: { "X-Request": "request-header" },
      fetch: customFetch,
      fetchOptions: {
        credentials: "include",
        headers: { "X-Options": "option-header" },
      },
    }),
  ),
  Effect.provide(FetchHttpClient.layer),
);

const result = await Effect.runPromise(program);
expect(result).toBe("0x1");
```
