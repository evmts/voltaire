---
title: Keystore Tests
description: Test examples for Keystore showing encrypted key storage with scrypt and pbkdf2.
---

## Encrypt a Private Key

Encrypts a private key to keystore v3 format with scrypt KDF.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const testPrivateKey = new Uint8Array([
  0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
  0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
  0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
  0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
])
const testPassword = 'test-password-123'

const program = Effect.gen(function* () {
  const result = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  })
  // result.version is 3
  // result.crypto.cipher is "aes-128-ctr"
  // result.crypto.kdf is "scrypt"
})
```

## Encrypt with PBKDF2

Encrypts a private key using pbkdf2 KDF instead of scrypt.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const testPrivateKey = new Uint8Array(32).fill(0x42)
const testPassword = 'test-password-123'

const program = Effect.gen(function* () {
  const result = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    kdf: 'pbkdf2',
    pbkdf2C: 1000,
  })
  // result.crypto.kdf is "pbkdf2"
})
```

## Decrypt a Keystore

Decrypts a keystore back to the original private key.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const testPrivateKey = new Uint8Array(32).fill(0x42)
const testPassword = 'test-password-123'

const program = Effect.gen(function* () {
  const encrypted = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  })
  const decrypted = yield* Keystore.decrypt(encrypted, testPassword)
  // decrypted equals testPrivateKey
})
```

## Service Layer Usage

Uses the KeystoreService with dependency injection.

```typescript
import { Effect } from 'effect'
import { KeystoreService, KeystoreLive } from 'voltaire-effect/crypto/Keystore'

const testPrivateKey = new Uint8Array(32).fill(0x42)
const testPassword = 'test-password-123'

const program = Effect.gen(function* () {
  const keystore = yield* KeystoreService
  const encrypted = yield* keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
  })
  const decrypted = yield* keystore.decrypt(encrypted, testPassword)
  // decrypted equals testPrivateKey
}).pipe(Effect.provide(KeystoreLive))
```

## Test Layer for Mocking

Uses the KeystoreTest layer for testing with mock data.

```typescript
import { Effect } from 'effect'
import { KeystoreService, KeystoreTest } from 'voltaire-effect/crypto/Keystore'

const program = Effect.gen(function* () {
  const keystore = yield* KeystoreService
  const result = yield* keystore.encrypt(new Uint8Array(32), 'password')
  // result.version is 3
  // result.id is "test-uuid"
}).pipe(Effect.provide(KeystoreTest))
```

## Secure Key Usage with withDecryptedKey

Uses withDecryptedKey to ensure private keys are zeroed after use.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const testPrivateKey = new Uint8Array(32).fill(0x42)
const testPassword = 'test-password-123'

const program = Effect.gen(function* () {
  const encrypted = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  })

  let capturedKey: Uint8Array | null = null

  yield* Keystore.withDecryptedKey(encrypted, testPassword, (key) =>
    Effect.sync(() => {
      capturedKey = key
      // Use the key here...
    })
  )

  // After withDecryptedKey returns, the key memory is zeroed
  // capturedKey.every(b => b === 0) is true
})
```

## Encrypt-Decrypt Round Trip with Scrypt

Demonstrates a complete encrypt-decrypt cycle with scrypt.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const program = Effect.gen(function* () {
  const testPrivateKey = new Uint8Array(32).fill(0xab)
  const testPassword = 'strong-password'
  
  const encrypted = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    scryptN: 1024,
    scryptR: 8,
    scryptP: 1,
  })
  const decrypted = yield* Keystore.decrypt(encrypted, testPassword)
  // decrypted equals testPrivateKey
})
```

## Encrypt-Decrypt Round Trip with PBKDF2

Demonstrates a complete encrypt-decrypt cycle with pbkdf2.

```typescript
import { Effect } from 'effect'
import * as Keystore from 'voltaire-effect/crypto/Keystore'

const program = Effect.gen(function* () {
  const testPrivateKey = new Uint8Array(32).fill(0xcd)
  const testPassword = 'strong-password'
  
  const encrypted = yield* Keystore.encrypt(testPrivateKey, testPassword, {
    kdf: 'pbkdf2',
    pbkdf2C: 1000,
  })
  const decrypted = yield* Keystore.decrypt(encrypted, testPassword)
  // decrypted equals testPrivateKey
})
```
