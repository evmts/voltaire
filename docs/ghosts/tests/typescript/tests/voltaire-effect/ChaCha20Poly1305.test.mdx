---
title: ChaCha20Poly1305 Tests
description: Test examples for ChaCha20-Poly1305 authenticated encryption with key/nonce generation and validation.
---

## Generate Key

Generates a 32-byte encryption key.

```typescript
import { Effect } from 'effect'
import { ChaCha20Poly1305Service, ChaCha20Poly1305Live } from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const service = yield* ChaCha20Poly1305Service
  const key = yield* service.generateKey()
  // key is a 32-byte Uint8Array
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Generate Nonce

Generates a 12-byte nonce.

```typescript
import { Effect } from 'effect'
import { ChaCha20Poly1305Service, ChaCha20Poly1305Live } from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const service = yield* ChaCha20Poly1305Service
  const nonce = yield* service.generateNonce()
  // nonce is a 12-byte Uint8Array
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Encrypt and Decrypt

Encrypts and decrypts data with authenticated encryption.

```typescript
import { Effect } from 'effect'
import { ChaCha20Poly1305Service, ChaCha20Poly1305Live } from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const plaintext = new TextEncoder().encode("Hello, ChaCha20!")
  const service = yield* ChaCha20Poly1305Service
  const key = yield* service.generateKey()
  const nonce = yield* service.generateNonce()
  const ciphertext = yield* service.encrypt(plaintext, key, nonce)
  const decrypted = yield* service.decrypt(ciphertext, key, nonce)
  // decrypted equals plaintext
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Encrypt with Additional Authenticated Data

Uses AAD for additional authentication context.

```typescript
import { Effect } from 'effect'
import { ChaCha20Poly1305Service, ChaCha20Poly1305Live } from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const plaintext = new TextEncoder().encode("Secret message")
  const aad = new TextEncoder().encode("header data")
  const service = yield* ChaCha20Poly1305Service
  const key = yield* service.generateKey()
  const nonce = yield* service.generateNonce()
  const ciphertext = yield* service.encrypt(plaintext, key, nonce, aad)
  const decrypted = yield* service.decrypt(ciphertext, key, nonce, aad)
  // decrypted equals plaintext
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Convenience Functions

Uses convenience functions for encryption operations.

```typescript
import { Effect } from 'effect'
import {
  ChaCha20Poly1305Live,
  generateKey,
  generateNonce,
  encrypt,
  decrypt
} from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const plaintext = new TextEncoder().encode("Test message")
  const key = yield* generateKey()
  const nonce = yield* generateNonce()
  const ciphertext = yield* encrypt(plaintext, key, nonce)
  const decrypted = yield* decrypt(ciphertext, key, nonce)
  // decrypted equals plaintext
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Invalid Key Size Validation

Rejects keys that are not 32 bytes.

```typescript
import { Effect, Exit } from 'effect'
import {
  ChaCha20Poly1305Live,
  encrypt,
  InvalidKeyError
} from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const plaintext = new Uint8Array([1, 2, 3])
  const invalidKey = new Uint8Array(16) // Should be 32 bytes
  const nonce = new Uint8Array(12)
  const exit = yield* Effect.exit(encrypt(plaintext, invalidKey, nonce))
  // exit is a Failure with InvalidKeyError
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Invalid Nonce Size Validation

Rejects nonces that are not 12 bytes.

```typescript
import { Effect, Exit } from 'effect'
import {
  ChaCha20Poly1305Live,
  encrypt,
  InvalidNonceError
} from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const plaintext = new Uint8Array([1, 2, 3])
  const key = new Uint8Array(32)
  const invalidNonce = new Uint8Array(8) // Should be 12 bytes
  const exit = yield* Effect.exit(encrypt(plaintext, key, invalidNonce))
  // exit is a Failure with InvalidNonceError
}).pipe(Effect.provide(ChaCha20Poly1305Live))
```

## Test Layer

Uses deterministic test layer for predictable results.

```typescript
import { Effect } from 'effect'
import {
  ChaCha20Poly1305Service,
  ChaCha20Poly1305Test
} from 'voltaire-effect/crypto/ChaCha20Poly1305'

const program = Effect.gen(function* () {
  const service = yield* ChaCha20Poly1305Service
  const key = yield* service.generateKey()
  const nonce = yield* service.generateNonce()
  // key is 32 bytes of zeros
  // nonce is 12 bytes of zeros
}).pipe(Effect.provide(ChaCha20Poly1305Test))
```
