---
title: Ccip Tests
description: Test examples for CcipService showing EIP-3668 CCIP-Read off-chain data fetching.
---

## GET request when URL contains data placeholder

Uses GET method when URL template includes {data}.

```typescript
import * as Effect from 'effect/Effect'
import { CcipService } from 'voltaire-effect'
import { DefaultCcip } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const ccip = yield* CcipService
  return yield* ccip.request({
    sender: '0x1234567890123456789012345678901234567890',
    callData: '0xdeadbeef',
    callbackSelector: '0x12345678',
    extraData: '0x',
    urls: ['https://gateway.example.com/{sender}/{data}'],
  })
}).pipe(Effect.provide(DefaultCcip))

// Fetch will be called with GET method
```

## POST request when URL lacks data placeholder

Uses POST method with JSON body when URL doesn't include {data}.

```typescript
import * as Effect from 'effect/Effect'
import { CcipService } from 'voltaire-effect'
import { DefaultCcip } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const ccip = yield* CcipService
  return yield* ccip.request({
    sender: '0x1234567890123456789012345678901234567890',
    callData: '0xdeadbeef',
    callbackSelector: '0x12345678',
    extraData: '0x',
    urls: ['https://gateway.example.com/{sender}'],
  })
}).pipe(Effect.provide(DefaultCcip))

// Fetch will be called with POST method and JSON body
```

## Multi-URL fallback

Tries next URL when first fails.

```typescript
import * as Effect from 'effect/Effect'
import { CcipService } from 'voltaire-effect'
import { DefaultCcip } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const ccip = yield* CcipService
  return yield* ccip.request({
    sender: '0x1234567890123456789012345678901234567890',
    callData: '0xdeadbeef',
    callbackSelector: '0x12345678',
    extraData: '0x',
    urls: [
      'https://first.example.com/{sender}/{data}',
      'https://second.example.com/{sender}/{data}',
    ],
  })
}).pipe(Effect.provide(DefaultCcip))
```

## Empty URL list fails

Returns CcipError when no URLs provided.

```typescript
import * as Effect from 'effect/Effect'
import * as Exit from 'effect/Exit'
import { CcipService, CcipError } from 'voltaire-effect'
import { DefaultCcip } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const ccip = yield* CcipService
  return yield* ccip.request({
    sender: '0x1234567890123456789012345678901234567890',
    callData: '0xdeadbeef',
    callbackSelector: '0x12345678',
    extraData: '0x',
    urls: [],
  })
}).pipe(Effect.provide(DefaultCcip))

const exit = await Effect.runPromiseExit(program)
expect(Exit.isFailure(exit)).toBe(true)
```

## Invalid hex response fails

Returns CcipError when response is not valid hex.

```typescript
import * as Effect from 'effect/Effect'
import * as Exit from 'effect/Exit'
import { CcipService, CcipError } from 'voltaire-effect'
import { DefaultCcip } from 'voltaire-effect'

// When response.data is 'not-hex' instead of '0x...'
const exit = await Effect.runPromiseExit(program)
if (Exit.isFailure(exit)) {
  const error = exit.cause._tag === 'Fail' ? exit.cause.error : null
  expect(error).toBeInstanceOf(CcipError)
  expect((error as CcipError).message).toContain('not valid hex')
}
```

## NoopCcip always fails

Disabled CCIP implementation always returns error.

```typescript
import * as Effect from 'effect/Effect'
import * as Exit from 'effect/Exit'
import { CcipService, CcipError } from 'voltaire-effect'
import { NoopCcip } from 'voltaire-effect'

const program = Effect.gen(function* () {
  const ccip = yield* CcipService
  return yield* ccip.request({
    sender: '0x1234567890123456789012345678901234567890',
    callData: '0xdeadbeef',
    callbackSelector: '0x12345678',
    extraData: '0x',
    urls: ['https://gateway.example.com/{sender}/{data}'],
  })
}).pipe(Effect.provide(NoopCcip))

const exit = await Effect.runPromiseExit(program)
expect(Exit.isFailure(exit)).toBe(true)
if (Exit.isFailure(exit)) {
  const error = exit.cause._tag === 'Fail' ? exit.cause.error : null
  expect((error as CcipError).message).toBe('CCIP disabled')
}
```
