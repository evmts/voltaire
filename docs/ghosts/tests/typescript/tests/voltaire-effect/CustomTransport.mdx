---
title: CustomTransport Tests
description: Test examples for CustomTransport showing EIP-1193 provider wrapping and custom request functions.
---

## Wraps an EIP-1193 provider

Demonstrates wrapping a standard EIP-1193 provider as a transport.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService } from 'voltaire-effect'

const mockProvider = {
  request: vi.fn().mockResolvedValue("0x123"),
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(Effect.provide(CustomTransport({ provider: mockProvider })))

const result = await Effect.runPromise(program)
expect(result).toBe("0x123")
expect(mockProvider.request).toHaveBeenCalledWith({
  method: "eth_blockNumber",
  params: [],
})
```

## Accepts provider directly without config wrapper

Shows that a provider can be passed directly without the config object.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService } from 'voltaire-effect'

const mockProvider = {
  request: vi.fn().mockResolvedValue("0x456"),
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_chainId", [])
}).pipe(Effect.provide(CustomTransport(mockProvider)))

const result = await Effect.runPromise(program)
expect(result).toBe("0x456")
```

## Uses injected window.ethereum when provider omitted

Demonstrates automatic detection of browser-injected ethereum provider.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService } from 'voltaire-effect'

const mockProvider = {
  request: vi.fn().mockResolvedValue("0x789"),
}
globalThis.window = { ethereum: mockProvider }

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_chainId", [])
}).pipe(Effect.provide(CustomTransport()))

const result = await Effect.runPromise(program)
expect(result).toBe("0x789")
```

## Handles provider errors with code and message

Shows proper error handling for EIP-1193 provider errors.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService, TransportError } from 'voltaire-effect'

const mockProvider = {
  request: vi.fn().mockRejectedValue({
    code: 4001,
    message: "User rejected",
  }),
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_requestAccounts", [])
}).pipe(Effect.provide(CustomTransport({ provider: mockProvider })))

const exit = await Effect.runPromiseExit(program)
expect(exit._tag).toBe("Failure")
if (exit._tag === "Failure" && exit.cause._tag === "Fail") {
  const error = exit.cause.error as TransportError
  expect(error.code).toBe(4001)
  expect(error.message).toBe("User rejected")
}
```

## Calls onRequest interceptor

Demonstrates the onRequest callback for logging or modifying requests.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService } from 'voltaire-effect'

const onRequest = vi.fn()
const mockProvider = {
  request: vi.fn().mockResolvedValue("0x1"),
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    CustomTransport({
      provider: mockProvider,
      onRequest,
    }),
  ),
)

await Effect.runPromise(program)
expect(onRequest).toHaveBeenCalledWith("eth_blockNumber", [])
```

## Calls onResponse interceptor

Shows the onResponse callback for processing or logging responses.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService } from 'voltaire-effect'

const onResponse = vi.fn()
const mockProvider = {
  request: vi.fn().mockResolvedValue("0x100"),
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    CustomTransport({
      provider: mockProvider,
      onResponse,
    }),
  ),
)

await Effect.runPromise(program)
expect(onResponse).toHaveBeenCalledWith("eth_blockNumber", "0x100")
```

## Handles request timeout

Demonstrates timeout handling for slow provider responses.

```typescript
import { Effect } from 'effect'
import { CustomTransport, TransportService, TransportError } from 'voltaire-effect'

const mockProvider = {
  request: vi.fn().mockImplementation(() => new Promise(() => {})), // Never resolves
}

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(
  Effect.provide(
    CustomTransport({
      provider: mockProvider,
      timeout: 50,
    }),
  ),
)

const exit = await Effect.runPromiseExit(program)
expect(exit._tag).toBe("Failure")
```

## CustomTransportFromFn - Creates transport from request function

Shows creating a transport from a simple async function.

```typescript
import { Effect } from 'effect'
import { CustomTransportFromFn, TransportService } from 'voltaire-effect'

const requestFn = vi.fn().mockResolvedValue("0x999")

const program = Effect.gen(function* () {
  const transport = yield* TransportService
  return yield* transport.request<string>("eth_blockNumber", [])
}).pipe(Effect.provide(CustomTransportFromFn(requestFn)))

const result = await Effect.runPromise(program)
expect(result).toBe("0x999")
expect(requestFn).toHaveBeenCalledWith({
  method: "eth_blockNumber",
  params: [],
})
```
