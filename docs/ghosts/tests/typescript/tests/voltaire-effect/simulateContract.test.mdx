---
title: simulateContract Tests
description: Test examples for simulateContract showing contract call simulation.
---

## simulateContract returns correct result for transfer simulation

Simulates a contract call and returns the expected result without executing on-chain.

```typescript
import { Effect, Layer } from 'effect'
import * as S from 'effect/Schema'
import { Address, Hex } from 'voltaire'
import { simulateContract } from 'voltaire-effect'
import { ProviderService, type ProviderShape } from 'voltaire-effect'
import { fromArray } from 'voltaire-effect/primitives/Abi/AbiSchema'

const erc20Abi = S.decodeUnknownSync(fromArray)([
  {
    type: "function",
    name: "transfer",
    inputs: [{ name: "to", type: "address" }, { name: "amount", type: "uint256" }],
    outputs: [{ type: "bool" }],
    stateMutability: "nonpayable",
  },
])

const createMockProvider = (callResult: `0x${string}`): Layer.Layer<ProviderService> => {
  const mockProvider: ProviderShape = {
    getBlockNumber: () => Effect.succeed(123n),
    call: () => Effect.succeed(callResult),
    estimateGas: () => Effect.succeed(21000n),
    // ... other methods
  }
  return Layer.succeed(ProviderService, mockProvider)
}

const trueResult = "0x0000000000000000000000000000000000000000000000000000000000000001"
const provider = createMockProvider(trueResult)

const program = simulateContract({
  address: "0x1234567890123456789012345678901234567890",
  abi: erc20Abi,
  functionName: "transfer",
  args: ["0xabcdef0123456789abcdef0123456789abcdef01", 1000n],
}).pipe(Effect.provide(provider))

const result = await Effect.runPromise(program)

expect(result.result).toBe(true)
```

## simulateContract populates request object correctly

The simulation result includes a request object with all call parameters.

```typescript
import { Effect, Layer } from 'effect'
import { Address, Hex } from 'voltaire'
import { simulateContract } from 'voltaire-effect'

const contractAddress = "0x1234567890123456789012345678901234567890"
const recipient = "0xabcdef0123456789abcdef0123456789abcdef01"
const amount = 1000n

const program = simulateContract({
  address: contractAddress,
  abi: erc20Abi,
  functionName: "transfer",
  args: [recipient, amount],
  value: 0n,
  gas: 100000n,
}).pipe(Effect.provide(provider))

const result = await Effect.runPromise(program)

expect(Address.toHex(result.request.address).toLowerCase()).toBe(contractAddress.toLowerCase())
expect(result.request.functionName).toBe("transfer")
expect(result.request.args).toEqual([recipient, amount])
expect(result.request.data).toBeDefined()
expect(Hex.isHex(result.request.data)).toBe(true)
expect(result.request.value).toBe(0n)
expect(result.request.gas).toBe(100000n)
```

## simulateContract handles simulation with account override

The from address can be overridden for simulation purposes.

```typescript
import { Effect, Layer } from 'effect'
import { simulateContract } from 'voltaire-effect'

let capturedRequest: any

const mockProvider: ProviderShape = {
  call: (request) => {
    capturedRequest = request
    return Effect.succeed(trueResult)
  },
  // ... other methods
}

const senderAddress = "0x9999999999999999999999999999999999999999"

const program = simulateContract({
  address: "0x1234567890123456789012345678901234567890",
  abi: erc20Abi,
  functionName: "transfer",
  args: ["0xabcdef0123456789abcdef0123456789abcdef01", 1000n],
  account: senderAddress,
}).pipe(Effect.provide(provider))

await Effect.runPromise(program)

expect(capturedRequest.from).toBe(senderAddress)
```

## simulateContract returns false result for failed transfer

The simulation correctly returns false when the simulated transfer would fail.

```typescript
import { Effect, Layer } from 'effect'
import { simulateContract } from 'voltaire-effect'

const falseResult = "0x0000000000000000000000000000000000000000000000000000000000000000"
const provider = createMockProvider(falseResult)

const program = simulateContract({
  address: "0x1234567890123456789012345678901234567890",
  abi: erc20Abi,
  functionName: "transfer",
  args: ["0xabcdef0123456789abcdef0123456789abcdef01", 1000n],
}).pipe(Effect.provide(provider))

const result = await Effect.runPromise(program)

expect(result.result).toBe(false)
```

## simulateContract fails on execution revert with data

Reverts with error data are properly propagated as failures.

```typescript
import { Effect, Layer } from 'effect'
import { simulateContract } from 'voltaire-effect'

const mockProvider: ProviderShape = {
  call: () => Effect.fail({
    message: "execution reverted",
    code: 3,
    data: "0x08c379a0...",
  } as any),
  // ... other methods
}

const program = simulateContract({
  address: "0x1234567890123456789012345678901234567890",
  abi: erc20Abi,
  functionName: "transfer",
  args: ["0xabcdef0123456789abcdef0123456789abcdef01", 1000n],
}).pipe(Effect.provide(Layer.succeed(ProviderService, mockProvider)))

await expect(Effect.runPromise(program)).rejects.toThrow()
```
