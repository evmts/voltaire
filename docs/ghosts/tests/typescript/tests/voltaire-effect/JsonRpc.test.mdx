---
title: JsonRpc Tests
description: Test examples for JSON-RPC module showing Request, Response, namespaces, error codes, and error parsing.
---

## Request Creation

Creates JSON-RPC requests from objects.

```typescript
import { describe, expect, it } from "vitest"
import { Request } from "voltaire-effect/jsonrpc"

describe("JsonRpc", () => {
  describe("Request", () => {
    it("creates a request from object", () => {
      const req = Request.from({
        method: "eth_blockNumber",
        params: [],
        id: 1,
      })
      expect(req.jsonrpc).toBe("2.0")
      expect(req.method).toBe("eth_blockNumber")
      expect(req.params).toEqual([])
      expect(req.id).toBe(1)
    })

    it("creates a notification (no id)", () => {
      const req = Request.from({
        method: "eth_subscribe",
        params: ["newHeads"],
      })
      expect(req.id).toBeUndefined()
      expect(Request.isNotification(req)).toBe(true)
    })

    it("withParams adds parameters to request", () => {
      const base = Request.from({ method: "eth_getBalance", id: 1 })
      const addParams = Request.withParams<[string, string]>(base)
      const req = addParams(["0x1234", "latest"])
      expect(req.params).toEqual(["0x1234", "latest"])
    })
  })
})
```

## Response Parsing

Parses JSON-RPC responses.

```typescript
import { describe, expect, it } from "vitest"
import * as Effect from "effect/Effect"
import { Response } from "voltaire-effect/jsonrpc"

describe("Response", () => {
  it("parses success response", async () => {
    const raw = {
      jsonrpc: "2.0",
      id: 1,
      result: "0x1234",
    }

    const program = Response.parse(raw)
    const response = await Effect.runPromise(program)
    expect(Response.isSuccess(response)).toBe(true)
    if (Response.isSuccess(response)) {
      expect(response.result).toBe("0x1234")
    }
  })

  it("parses error response", async () => {
    const raw = {
      jsonrpc: "2.0",
      id: 1,
      error: {
        code: -32601,
        message: "Method not found",
      },
    }

    const program = Response.parse(raw)
    const response = await Effect.runPromise(program)
    expect(Response.isError(response)).toBe(true)
    if (Response.isError(response)) {
      expect(response.error.code).toBe(-32601)
    }
  })

  it("unwrap extracts result from success", async () => {
    const raw = { jsonrpc: "2.0", id: 1, result: "0x5678" }

    const program = Effect.gen(function* () {
      const response = yield* Response.parse(raw)
      return yield* Response.unwrap(response)
    })

    const result = await Effect.runPromise(program)
    expect(result).toBe("0x5678")
  })
})
```

## Eth Namespace

Creates Eth namespace requests.

```typescript
import { describe, expect, it } from "vitest"
import { Eth } from "voltaire-effect/jsonrpc"

describe("Eth namespace", () => {
  it("creates BlockNumberRequest", () => {
    const req = Eth.BlockNumberRequest()
    expect(req.method).toBe("eth_blockNumber")
  })

  it("creates GetBalanceRequest", () => {
    const req = Eth.GetBalanceRequest("0x1234", "latest")
    expect(req.method).toBe("eth_getBalance")
    expect(req.params).toEqual(["0x1234", "latest"])
  })

  it("creates GetBlockByNumberRequest", () => {
    const req = Eth.GetBlockByNumberRequest("0x1", false)
    expect(req.method).toBe("eth_getBlockByNumber")
    expect(req.params).toEqual(["0x1", false])
  })
})
```

## Net and Web3 Namespaces

Creates network and utility requests.

```typescript
import { describe, expect, it } from "vitest"
import { Net, Web3, Txpool } from "voltaire-effect/jsonrpc"

describe("Net namespace", () => {
  it("creates VersionRequest", () => {
    const req = Net.VersionRequest()
    expect(req.method).toBe("net_version")
  })

  it("creates ListeningRequest", () => {
    const req = Net.ListeningRequest()
    expect(req.method).toBe("net_listening")
  })
})

describe("Web3 namespace", () => {
  it("creates ClientVersionRequest", () => {
    const req = Web3.ClientVersionRequest()
    expect(req.method).toBe("web3_clientVersion")
  })

  it("creates Sha3Request", () => {
    const req = Web3.Sha3Request("0x68656c6c6f")
    expect(req.method).toBe("web3_sha3")
    expect(req.params).toEqual(["0x68656c6c6f"])
  })
})

describe("Txpool namespace", () => {
  it("creates StatusRequest", () => {
    const req = Txpool.StatusRequest()
    expect(req.method).toBe("txpool_status")
  })
})
```

## EIP-1193 Error Codes

Exposes EIP-1193 provider error codes.

```typescript
import { describe, expect, it } from "vitest"
import {
  JsonRpcError,
  isUserRejected,
  isDisconnected,
  isProviderError,
  isExecutionReverted,
  isNonceError,
  isInsufficientFunds,
  USER_REJECTED_REQUEST,
  DISCONNECTED,
  CHAIN_DISCONNECTED,
  EXECUTION_REVERTED,
  NONCE_TOO_LOW,
  NONCE_TOO_HIGH,
  INSUFFICIENT_FUNDS,
} from "voltaire-effect/jsonrpc"

describe("EIP-1193 Provider Error Codes", () => {
  it("exposes EIP-1193 provider error codes", () => {
    expect(JsonRpcError.USER_REJECTED_REQUEST).toBe(4001)
    expect(JsonRpcError.UNAUTHORIZED).toBe(4100)
    expect(JsonRpcError.UNSUPPORTED_METHOD).toBe(4200)
    expect(JsonRpcError.DISCONNECTED).toBe(4900)
    expect(JsonRpcError.CHAIN_DISCONNECTED).toBe(4901)
  })

  it("isUserRejected helper", () => {
    expect(isUserRejected(USER_REJECTED_REQUEST)).toBe(true)
    expect(isUserRejected(4002)).toBe(false)
  })

  it("isDisconnected helper", () => {
    expect(isDisconnected(DISCONNECTED)).toBe(true)
    expect(isDisconnected(CHAIN_DISCONNECTED)).toBe(true)
    expect(isDisconnected(4001)).toBe(false)
  })

  it("isExecutionReverted helper", () => {
    expect(isExecutionReverted(EXECUTION_REVERTED)).toBe(true)
    expect(isExecutionReverted(3)).toBe(true)
    expect(isExecutionReverted(-32000)).toBe(false)
  })

  it("isNonceError helper", () => {
    expect(isNonceError(NONCE_TOO_LOW)).toBe(true)
    expect(isNonceError(NONCE_TOO_HIGH)).toBe(true)
    expect(isNonceError(-32010)).toBe(false)
  })

  it("isInsufficientFunds helper", () => {
    expect(isInsufficientFunds(INSUFFICIENT_FUNDS)).toBe(true)
    expect(isInsufficientFunds(-32010)).toBe(true)
    expect(isInsufficientFunds(-32011)).toBe(false)
  })
})
```

## Node-specific Error Classes

Creates typed error classes for specific RPC errors.

```typescript
import { describe, expect, it } from "vitest"
import {
  ExecutionRevertedError,
  InsufficientFundsError,
  NonceTooLowError,
  NonceTooHighError,
} from "voltaire-effect/jsonrpc"

describe("Node-specific Error Classes", () => {
  it("ExecutionRevertedError has correct tag and code", () => {
    const error = new ExecutionRevertedError("Contract reverted")
    expect(error._tag).toBe("ExecutionRevertedError")
    expect(error.rpcCode).toBe(3)
    expect(error.message).toBe("Contract reverted")
  })

  it("InsufficientFundsError has correct tag and code", () => {
    const error = new InsufficientFundsError("Not enough ETH")
    expect(error._tag).toBe("InsufficientFundsError")
    expect(error.rpcCode).toBe(-32010)
    expect(error.message).toBe("Not enough ETH")
  })

  it("NonceTooLowError has correct tag and code", () => {
    const error = new NonceTooLowError("Nonce already used")
    expect(error._tag).toBe("NonceTooLowError")
    expect(error.rpcCode).toBe(-32011)
  })

  it("NonceTooHighError has correct tag and code", () => {
    const error = new NonceTooHighError("Nonce gap detected")
    expect(error._tag).toBe("NonceTooHighError")
    expect(error.rpcCode).toBe(-32012)
  })
})
```

## parseErrorCode

Parses error codes into typed error objects.

```typescript
import { describe, expect, it } from "vitest"
import { parseErrorCode } from "voltaire-effect/jsonrpc"

describe("parseErrorCode", () => {
  it("parses execution reverted code", () => {
    const error = parseErrorCode({ code: 3, message: "revert" })
    expect(error._tag).toBe("ExecutionRevertedError")
  })

  it("parses insufficient funds code", () => {
    const error = parseErrorCode({ code: -32010 })
    expect(error._tag).toBe("InsufficientFundsError")
  })

  it("parses nonce too low code", () => {
    const error = parseErrorCode({ code: -32011 })
    expect(error._tag).toBe("NonceTooLowError")
  })

  it("parses nonce too high code", () => {
    const error = parseErrorCode({ code: -32012 })
    expect(error._tag).toBe("NonceTooHighError")
  })

  it("parses unknown code as JsonRpcError", () => {
    const error = parseErrorCode({ code: -99999, message: "Unknown" })
    expect(error._tag).toBe("JsonRpcError")
  })
})
```
