---
title: Sign for Gnosis Safe / Multisig
description: Create signatures for Safe transaction execution
---

## Goal

Sign a Safe transaction for multisig execution.

## Code

```typescript
import * as EIP712 from '@voltaire/crypto/EIP712';
import * as Address from '@voltaire/primitives/Address';
import * as Keccak256 from '@voltaire/crypto/Keccak256';

// Safe domain
const domain = {
  chainId: 1n,
  verifyingContract: Address.from(safeAddress)
};

// Safe transaction types
const types = {
  SafeTx: [
    { name: 'to', type: 'address' },
    { name: 'value', type: 'uint256' },
    { name: 'data', type: 'bytes' },
    { name: 'operation', type: 'uint8' },
    { name: 'safeTxGas', type: 'uint256' },
    { name: 'baseGas', type: 'uint256' },
    { name: 'gasPrice', type: 'uint256' },
    { name: 'gasToken', type: 'address' },
    { name: 'refundReceiver', type: 'address' },
    { name: 'nonce', type: 'uint256' }
  ]
};

// Transaction to sign
const safeTx = {
  to: Address.from(targetAddress),
  value: 0n,
  data: calldata,                   // Encoded function call
  operation: 0,                     // 0 = Call, 1 = DelegateCall
  safeTxGas: 0n,
  baseGas: 0n,
  gasPrice: 0n,
  gasToken: Address.from('0x0000000000000000000000000000000000000000'),
  refundReceiver: Address.from('0x0000000000000000000000000000000000000000'),
  nonce: safeNonce                  // Get from safe.nonce()
};

// Create typed data
const typedData = {
  domain,
  types,
  primaryType: 'SafeTx',
  message: safeTx
};

// Sign with owner's key
const signature = EIP712.signTypedData(typedData, ownerPrivateKey);
```

## Combine Signatures

```typescript
// Safe requires signatures sorted by owner address (ascending)
function combineSignatures(
  signatures: Array<{ signer: string; r: Uint8Array; s: Uint8Array; v: number }>
): Uint8Array {
  // Sort by signer address
  const sorted = signatures.sort((a, b) =>
    a.signer.toLowerCase().localeCompare(b.signer.toLowerCase())
  );

  // Concatenate: r (32) + s (32) + v (1) for each
  const combined = new Uint8Array(sorted.length * 65);
  sorted.forEach((sig, i) => {
    combined.set(sig.r, i * 65);
    combined.set(sig.s, i * 65 + 32);
    combined[i * 65 + 64] = sig.v;
  });

  return combined;
}
```

## Execute Transaction

```typescript
// Execute with collected signatures
await safe.execTransaction(
  safeTx.to,
  safeTx.value,
  safeTx.data,
  safeTx.operation,
  safeTx.safeTxGas,
  safeTx.baseGas,
  safeTx.gasPrice,
  safeTx.gasToken,
  safeTx.refundReceiver,
  combinedSignatures
);
```

## Message Signing (Off-chain)

```typescript
// Sign arbitrary message for Safe (EIP-1271)
const messageHash = Keccak256.hash(messageBytes);

// Safe message types
const messageTypes = {
  SafeMessage: [
    { name: 'message', type: 'bytes' }
  ]
};

const typedData = {
  domain,
  types: messageTypes,
  primaryType: 'SafeMessage',
  message: { message: messageHash }
};

const signature = EIP712.signTypedData(typedData, ownerPrivateKey);
```

## Get Safe Nonce

```typescript
// Query current nonce from Safe contract
const nonce = await safe.nonce();
```
