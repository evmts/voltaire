---
title: How to Calculate APY from On-Chain Data
description: Calculate Annual Percentage Yield (APY) from lending protocol rate data.
---

## Goal

Query on-chain interest rate data and calculate APY for lending/borrowing positions.

Return as:

ANSWER: Supply APY: X.XX% | Borrow APY: Y.YY%

## Concepts

**APR vs APY**:
- APR (Annual Percentage Rate): Simple interest without compounding
- APY (Annual Percentage Yield): Compound interest

**Formula**: `APY = (1 + APR/n)^n - 1`
- `n` = compounding periods per year

Most DeFi protocols compound per block or continuously:
- Aave: Per-second compounding (RAY = 1e27 precision)
- Compound: Per-block compounding

## Aave V3 Example

```ts
import { Contract } from '@tevm/voltaire/contract'

const poolDataProviderAbi = [
  {
    type: 'function',
    name: 'getReserveData',
    stateMutability: 'view',
    inputs: [{ name: 'asset', type: 'address' }],
    outputs: [
      { name: 'unbacked', type: 'uint256' },
      { name: 'accruedToTreasuryScaled', type: 'uint256' },
      { name: 'totalAToken', type: 'uint256' },
      { name: 'totalStableDebt', type: 'uint256' },
      { name: 'totalVariableDebt', type: 'uint256' },
      { name: 'liquidityRate', type: 'uint256' },
      { name: 'variableBorrowRate', type: 'uint256' },
      { name: 'stableBorrowRate', type: 'uint256' },
      { name: 'averageStableBorrowRate', type: 'uint256' },
      { name: 'liquidityIndex', type: 'uint256' },
      { name: 'variableBorrowIndex', type: 'uint256' },
      { name: 'lastUpdateTimestamp', type: 'uint40' }
    ]
  }
] as const

const DATA_PROVIDER = '0x7B4EB56E7CD4b454BA8ff71E4518426369a138a3'
const USDC = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'

const dataProvider = Contract({
  address: DATA_PROVIDER,
  abi: poolDataProviderAbi,
  provider
})

const reserveData = await dataProvider.read.getReserveData(USDC)
const liquidityRate = reserveData[5] // Supply rate in RAY
const variableBorrowRate = reserveData[6] // Borrow rate in RAY

// Aave uses RAY (1e27) for rate precision
const RAY = 10n ** 27n
const SECONDS_PER_YEAR = 31536000n

// Convert RAY rate to APY
function rayToAPY(rayRate: bigint): number {
  const apr = Number(rayRate) / Number(RAY)
  // Continuous compounding: APY = e^(APR) - 1
  return (Math.exp(apr) - 1) * 100
}

// Or use discrete compounding per second
function rayToAPYDiscrete(rayRate: bigint): number {
  const ratePerSecond = Number(rayRate) / Number(RAY)
  const secondsPerYear = 31536000
  return (Math.pow(1 + ratePerSecond / secondsPerYear, secondsPerYear) - 1) * 100
}

const supplyAPY = rayToAPY(liquidityRate)
const borrowAPY = rayToAPY(variableBorrowRate)

console.log(`ANSWER: Supply APY: ${supplyAPY.toFixed(2)}% | Borrow APY: ${borrowAPY.toFixed(2)}%`)
```

## Compound V3 Example

```ts
const cometAbi = [
  {
    type: 'function',
    name: 'getSupplyRate',
    stateMutability: 'view',
    inputs: [{ name: 'utilization', type: 'uint256' }],
    outputs: [{ name: '', type: 'uint64' }]
  },
  {
    type: 'function',
    name: 'getBorrowRate',
    stateMutability: 'view',
    inputs: [{ name: 'utilization', type: 'uint256' }],
    outputs: [{ name: '', type: 'uint64' }]
  },
  {
    type: 'function',
    name: 'getUtilization',
    stateMutability: 'view',
    inputs: [],
    outputs: [{ name: '', type: 'uint256' }]
  }
] as const

const COMET_USDC = '0xc3d688B66703497DAA19211EEdff47f25384cdc3'

const comet = Contract({
  address: COMET_USDC,
  abi: cometAbi,
  provider
})

const utilization = await comet.read.getUtilization()
const supplyRate = await comet.read.getSupplyRate(utilization)
const borrowRate = await comet.read.getBorrowRate(utilization)

// Compound V3 rates are per second with 18 decimal precision
const SECONDS_PER_YEAR = 31536000
const SCALE = 1e18

function rateToAPY(ratePerSecond: bigint): number {
  const rate = Number(ratePerSecond) / SCALE
  return (Math.pow(1 + rate, SECONDS_PER_YEAR) - 1) * 100
}

const supplyAPY = rateToAPY(supplyRate)
const borrowAPY = rateToAPY(borrowRate)

console.log(`ANSWER: Supply APY: ${supplyAPY.toFixed(2)}% | Borrow APY: ${borrowAPY.toFixed(2)}%`)
```

## Uniswap LP APY (Approximate)

```ts
// LP APY based on trading fees
async function estimateLPAPY(
  dailyVolumeUSD: number,
  totalLiquidityUSD: number,
  feePercent: number = 0.3
): Promise<number> {
  const dailyFees = dailyVolumeUSD * (feePercent / 100)
  const dailyReturn = dailyFees / totalLiquidityUSD
  const yearlyReturn = dailyReturn * 365
  // Simple APY (doesn't account for compounding)
  return yearlyReturn * 100
}

// For accurate LP APY, track actual returns over time
// or use protocol analytics APIs
```

## Historical APY

```ts
// Track index changes over time for actual realized APY
async function calculateHistoricalAPY(
  indexNow: bigint,
  indexThen: bigint,
  timeElapsedSeconds: number
): Promise<number> {
  const growth = Number(indexNow) / Number(indexThen)
  const secondsPerYear = 31536000
  const annualized = Math.pow(growth, secondsPerYear / timeElapsedSeconds)
  return (annualized - 1) * 100
}
```

## Notes

- On-chain rates are instantaneous - APY fluctuates with utilization
- Aave RAY = 1e27, Compound per-second = 1e18 precision
- Consider gas costs when calculating net returns
- Some protocols offer additional token rewards (check incentives contracts)
- Historical APY is more reliable than instantaneous rates
