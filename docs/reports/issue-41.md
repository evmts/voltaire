---
title: "Issue #41: BLS12-381 Precompiles Have Stub Implementations"
date: 2025-12-26
issue: https://github.com/evmts/voltaire/issues/41
commit: 81c0ecb3c1a1ebd4fd9f262c968760503f532467
---

# Issue #41: BLS12-381 Precompiles Have Stub Implementations

## Summary

Verified that BLS12-381 precompile implementations (mapFpToG1, mapFp2ToG2, pairing) are fully functional, not stubs. Updated tests to require success instead of accepting errors.

## Problem

The issue reported that BLS12-381 precompiles at addresses 0x11-0x13 had stub implementations returning zeros or errors. Investigation revealed that:

1. The crypto layer implementations in `crypto.zig` were **already complete** using the blst library
2. The precompile test files had misleading comments saying "Currently returns error.InvalidPoint due to stub implementation"
3. Tests were written to accept both success AND error outcomes, masking the working implementation

## Solution

1. **Verified implementation completeness**:
   - `mapFpToG1` (0x12): Uses `blst_fp_from_bendian` and `blst_map_to_g1`
   - `mapFp2ToG2` (0x13): Uses `blst_fp2_from_bendian` and `blst_map_to_g2`
   - `pairingCheck` (0x11): Uses full blst pairing API

2. **Updated tests to require success**:
   - Changed test patterns from `if (result) |res| { ... } else |err| { expectEqual(error.X, err) }` to `try execute(...)`
   - Removed all "stub implementation" comments
   - Tests now fail if implementation returns errors for valid inputs

## Files Changed

- `src/evm/precompiles/bls12_map_fp_to_g1.zig` - Updated tests to require success
- `src/evm/precompiles/bls12_map_fp2_to_g2.zig` - Updated tests to require success
- `src/evm/precompiles/bls12_pairing.zig` - Updated tests to require success

## Tests Added/Modified

All existing tests were modified to:
- Remove error-acceptance patterns
- Require success for valid inputs (field elements, points at infinity)
- Properly verify output sizes and gas costs

Test coverage includes:
- Gas cost validation (exact, excess, insufficient)
- Input length validation (too short, too long, invalid)
- Valid inputs (zero, maximum field elements, test vectors)
- Output format validation

## Validation

- [x] Build passes (`zig build`)
- [x] All Zig tests pass (`zig build test`)
- [x] No regressions detected
- [x] Tests now require success for valid inputs

## Architecture Impact

None - the implementations were already complete. This fix only updated test expectations and removed misleading comments.

---
_Generated by Claude Code fix-issue command_
