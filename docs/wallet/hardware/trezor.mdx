---
title: "Trezor Integration"
description: "Integrate Trezor hardware wallets for secure transaction signing"
---

# Trezor Hardware Wallet

Trezor integration provides secure transaction signing through Trezor devices (Trezor One, Trezor Model T) using Trezor Connect.

## Installation

Hardware wallet dependencies are included:

```bash
bun add @tevm/voltaire
# Includes @trezor/connect-web
```

## Quick Start

```typescript
import { createTrezor } from '@tevm/voltaire/wallet/hardware';

const trezor = createTrezor({
  manifest: {
    email: 'developer@example.com',
    appUrl: 'https://example.com'
  }
});

// Connect to device
await trezor.connect();

// Get address
const address = await trezor.getAddress("m/44'/60'/0'/0/0");

// Sign transaction
const signature = await trezor.signTransaction("m/44'/60'/0'/0/0", tx);

// Clean up
await trezor.disconnect();
```

## Connection

### Trezor Connect Setup

Trezor requires an app manifest for Connect:

```typescript
import { TrezorWallet } from '@tevm/voltaire/wallet/hardware';

const trezor = new TrezorWallet({
  manifest: {
    email: 'support@myapp.com',
    appUrl: 'https://myapp.com'
  }
});

try {
  await trezor.connect();
  console.log('Connected to Trezor');
} catch (error) {
  console.error('Connection failed:', error);
}
```

**Manifest Requirements:**
- `email`: Contact email for your application
- `appUrl`: URL where your app is hosted

**Connection Methods:**
- **Trezor Bridge**: Desktop application (recommended)
- **WebUSB**: Browser-based (Chrome/Chromium only)

### Installation Requirements

**Trezor Bridge (Recommended):**
1. Download from [trezor.io/start](https://trezor.io/start)
2. Install for your OS
3. Bridge runs in background
4. Works with all browsers

**WebUSB (Alternative):**
- Chrome/Chromium 61+ only
- HTTPS or localhost required
- No additional software needed
- Enable in Trezor device settings

### Connection Troubleshooting

```typescript
try {
  await trezor.connect();
} catch (error) {
  const msg = error.payload?.error || error.message;

  if (msg.includes('Popup closed')) {
    console.error('User cancelled connection');
  } else if (msg.includes('Device disconnected')) {
    console.error('Trezor not connected via USB');
  } else if (msg.includes('Permissions not granted')) {
    console.error('User denied device permissions');
  } else if (msg.includes('Outdated firmware')) {
    console.error('Update Trezor firmware');
  } else {
    console.error('Connection error:', msg);
  }
}
```

## Address Derivation

### Single Address

```typescript
// Get address (displayed on Trezor screen for verification)
const address = await trezor.getAddress("m/44'/60'/0'/0/0");

// User should verify address matches Trezor display
console.log('Verify address on Trezor:', address);
```

### Multiple Addresses (Batch Retrieval)

Trezor supports efficient batch address retrieval:

```typescript
// Get 10 addresses at once
const addresses = await trezor.getAddresses("m/44'/60'/0'/0", 10);

addresses.forEach((addr, i) => {
  console.log(`Address ${i}: ${addr}`);
});

// Trezor optimizes this into a single device call
```

### Common Derivation Paths

```typescript
// Standard paths
const metamask = await trezor.getAddress("m/44'/60'/0'/0/0");      // MetaMask compatible
const first = await trezor.getAddress("m/44'/60'/0'/0/0");         // First address
const second = await trezor.getAddress("m/44'/60'/0'/0/1");        // Second address

// Multiple accounts
const account0 = await trezor.getAddress("m/44'/60'/0'/0/0");
const account1 = await trezor.getAddress("m/44'/60'/1'/0/0");
const account2 = await trezor.getAddress("m/44'/60'/2'/0/0");
```

## Transaction Signing

### Legacy Transactions

```typescript
const tx = {
  to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0',
  value: 1000000000000000000n, // 1 ETH
  gas: 21000n,
  gasPrice: 20000000000n, // 20 gwei
  nonce: 0n,
  chainId: 1
};

// User confirms on Trezor device
const signature = await trezor.signTransaction("m/44'/60'/0'/0/0", tx);
```

### EIP-1559 Transactions

```typescript
const eip1559Tx = {
  to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0',
  value: 1000000000000000000n,
  gas: 21000n,
  maxFeePerGas: 30000000000n,        // 30 gwei
  maxPriorityFeePerGas: 1000000000n, // 1 gwei
  nonce: 0n,
  chainId: 1
};

const signature = await trezor.signTransaction("m/44'/60'/0'/0/0", eip1559Tx);
```

### Contract Interaction

```typescript
import * as Abi from '@tevm/voltaire/Abi';

// Encode function call
const data = Abi.encodeFunctionData({
  abi: contractAbi,
  functionName: 'transfer',
  args: ['0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0', 1000000n]
});

const tx = {
  to: tokenAddress,
  value: 0n,
  gas: 100000n,
  maxFeePerGas: 30000000000n,
  maxPriorityFeePerGas: 1000000000n,
  nonce: 0n,
  chainId: 1,
  data
};

// Trezor displays contract interaction details
const signature = await trezor.signTransaction("m/44'/60'/0'/0/0", tx);
```

**Display Features:**
- **Model T**: Full color touchscreen, detailed transaction display
- **One**: Monochrome display, basic transaction details

## Message Signing

### Personal Messages (EIP-191)

```typescript
// Sign text message
const message = new TextEncoder().encode('Sign in to MyApp');
const signature = await trezor.signMessage("m/44'/60'/0'/0/0", message);

// User confirms message on Trezor screen
// Message is hashed with Ethereum prefix
```

**Display:**
- Model T: Full message display with scrolling
- One: Message hash only (blind signing)

### Typed Data (EIP-712)

```typescript
const typedData = {
  types: {
    EIP712Domain: [
      { name: 'name', type: 'string' },
      { name: 'version', type: 'string' },
      { name: 'chainId', type: 'uint256' }
    ],
    Transfer: [
      { name: 'from', type: 'address' },
      { name: 'to', type: 'address' },
      { name: 'amount', type: 'uint256' }
    ]
  },
  primaryType: 'Transfer',
  domain: {
    name: 'MyToken',
    version: '1',
    chainId: 1
  },
  message: {
    from: '0xaaa...',
    to: '0xbbb...',
    amount: '1000000000000000000'
  }
};

// Trezor displays structured typed data
const signature = await trezor.signTypedData("m/44'/60'/0'/0/0", typedData);
```

**Device Support:**
- **Model T**: Full typed data display with field-by-field review
- **One**: Domain hash + message hash (blind signing)

## Device Features

### Get Device Info

```typescript
const info = await trezor.getDeviceInfo();

console.log(info.manufacturer); // "Trezor"
console.log(info.model);        // "T" or "1"
console.log(info.version);      // Firmware version (e.g., "2.5.3")
```

### Firmware Features

Different firmware versions support different features:

| Feature | Trezor One | Trezor Model T |
|---------|------------|----------------|
| Legacy TX | ✓ | ✓ |
| EIP-1559 TX | ✓ (fw 1.10.0+) | ✓ |
| EIP-712 | Limited | ✓ Full display |
| Personal Sign | Hash only | Full message |
| Batch Addresses | ✓ | ✓ |

### Passphrase Support

Trezor supports optional passphrases for additional security:

```typescript
// Enable passphrase in Trezor device settings
// User enters passphrase on device for each operation

// Derivation paths remain the same
// But passphrase creates different set of addresses
const address = await trezor.getAddress("m/44'/60'/0'/0/0");
```

**Passphrase Usage:**
- Optional additional security layer
- Creates different wallet per passphrase
- Must remember passphrase (cannot recover)
- Entered on device, never on computer

## Complete Example

```typescript
import { createTrezor } from '@tevm/voltaire/wallet/hardware';
import * as Transaction from '@tevm/voltaire/Transaction';

async function sendWithTrezor() {
  const trezor = createTrezor({
    manifest: {
      email: 'support@myapp.com',
      appUrl: 'https://myapp.com'
    }
  });

  try {
    // 1. Connect to Trezor
    console.log('Initializing Trezor Connect...');
    await trezor.connect();

    // 2. Get device info
    const info = await trezor.getDeviceInfo();
    console.log(`Connected to Trezor ${info.model} (fw ${info.version})`);

    // 3. Get addresses
    console.log('Retrieving addresses...');
    const addresses = await trezor.getAddresses("m/44'/60'/0'/0", 3);
    console.log('Available addresses:', addresses);

    // 4. Use first address
    const address = addresses[0];

    // 5. Build transaction
    const tx = {
      to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0',
      value: 1000000000000000000n,
      gas: 21000n,
      maxFeePerGas: 30000000000n,
      maxPriorityFeePerGas: 1000000000n,
      nonce: 0n,
      chainId: 1
    };

    // 6. Sign on device
    console.log('Please confirm on Trezor...');
    const signature = await trezor.signTransaction("m/44'/60'/0'/0/0", tx);

    // 7. Create signed transaction
    const signedTx = Transaction.sign(tx, signature);
    const serialized = Transaction.serialize(signedTx);

    console.log('Signed transaction:', serialized);

    // 8. Broadcast (using your preferred method)
    // await provider.sendRawTransaction(serialized);

  } catch (error) {
    if (error.payload) {
      console.error('Trezor error:', error.payload.error);
    } else {
      console.error('Error:', error.message);
    }
  } finally {
    await trezor.disconnect();
  }
}
```

## Best Practices

1. **Always provide valid manifest**
   ```typescript
   const trezor = createTrezor({
     manifest: {
       email: 'support@yourapp.com',  // Real contact email
       appUrl: 'https://yourapp.com'  // Your app's URL
     }
   });
   ```

2. **Handle popup interactions**
   - Trezor Connect opens popup window
   - Must have popup blocker disabled
   - Handle popup close events

3. **Verify addresses on device**
   ```typescript
   const address = await trezor.getAddress(path);
   // User MUST verify address on Trezor screen
   console.log('Verify this address on Trezor:', address);
   ```

4. **Batch address retrieval**
   ```typescript
   // Efficient: single device call
   const addrs = await trezor.getAddresses("m/44'/60'/0'/0", 10);

   // Inefficient: 10 device calls
   // for (let i = 0; i < 10; i++) {
   //   await trezor.getAddress(`m/44'/60'/0'/0/${i}`);
   // }
   ```

5. **Handle firmware updates**
   ```typescript
   try {
     await trezor.connect();
   } catch (error) {
     if (error.payload?.error.includes('Outdated firmware')) {
       alert('Please update your Trezor firmware at trezor.io/start');
     }
   }
   ```

6. **Clear error messages**
   - "Connect your Trezor device"
   - "Follow the instructions on your Trezor screen"
   - "Please confirm the transaction on your Trezor"

## Error Handling

```typescript
try {
  const signature = await trezor.signTransaction(path, tx);
} catch (error) {
  const code = error.payload?.code;
  const message = error.payload?.error || error.message;

  switch (code) {
    case 'Failure_ActionCancelled':
      console.log('User cancelled on device');
      break;
    case 'Failure_PinInvalid':
      console.log('Invalid PIN entered');
      break;
    case 'Device_CallInProgress':
      console.log('Another operation in progress');
      break;
    case 'Failure_NotInitialized':
      console.log('Device not initialized');
      break;
    default:
      console.error('Error:', message);
  }
}
```

**Common Error Codes:**
- `Failure_ActionCancelled`: User rejected on device
- `Failure_PinInvalid`: Wrong PIN
- `Device_CallInProgress`: Device busy
- `Failure_NotInitialized`: Device setup incomplete
- `Popup_closed`: User closed Connect popup

## Limitations

- **Popup required**: Trezor Connect uses popup window
- **Bridge or WebUSB**: Requires Trezor Bridge or WebUSB support
- **HTTPS required**: Security restriction (or localhost)
- **One operation at a time**: Sequential only
- **Display limitations**: Trezor One has limited display

## Device Comparison

| Feature | Trezor One | Trezor Model T |
|---------|------------|----------------|
| Display | 128×64 monochrome | 240×240 color touchscreen |
| EIP-712 | Hash only | Full display |
| Message signing | Hash only | Full message |
| Input | 2 buttons | Touchscreen |
| USB | Micro-USB | USB-C |
| Passphrase | ✓ | ✓ |
| Batch operations | ✓ | ✓ |

## See Also

- [Hardware Wallet Overview](./index)
- [Ledger Integration](./ledger)
- [Transaction Signing](/Transaction)
- [HD Wallet Derivation](/HDWallet)
- [Trezor Developer Docs](https://docs.trezor.io/)
