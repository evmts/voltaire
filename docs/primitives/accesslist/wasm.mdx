---
title: "WASM"
description: "WASM"
---

# WASM

WebAssembly bindings for high-performance AccessList operations.

## Overview

The WASM module provides optimized implementations of performance-critical AccessList operations using Zig. Functions are exposed through the wasm-loader.

**Available Operations:**
- `gasCostWasm` - Calculate gas cost
- `gasSavingsWasm` - Calculate gas savings
- `includesAddressWasm` - Check address presence
- `includesStorageKeyWasm` - Check storage key presence

## Functions

### gasCostWasm()

Calculate total gas cost using WASM implementation.

```typescript
gasCostWasm(accessList: BrandedAccessList): bigint
```

**Parameters:**
- `accessList`: Access list to calculate cost for

**Returns:** Total gas cost in wei

**Example:**
```typescript
import { gasCostWasm } from './AccessList.wasm.js';

const list = AccessList.create()
  .withAddress(addr)
  .withStorageKey(addr, key);

const cost = gasCostWasm(list);
// Same result as AccessList.gasCost() but faster
```

**Performance:**
- ~2-5x faster than JavaScript for large lists
- Memory-efficient byte processing
- No garbage collection overhead

### gasSavingsWasm()

Calculate gas savings using WASM implementation.

```typescript
gasSavingsWasm(accessList: BrandedAccessList): bigint
```

**Parameters:**
- `accessList`: Access list to calculate savings for

**Returns:** Potential gas savings in wei

**Example:**
```typescript
import { gasSavingsWasm } from './AccessList.wasm.js';

const savings = gasSavingsWasm(list);
const cost = gasCostWasm(list);
const beneficial = savings > cost;
```

**Performance:**
- Similar speed to gasCostWasm
- Optimized for large lists with many keys

### includesAddressWasm()

Check if address exists using WASM implementation.

```typescript
includesAddressWasm(
  accessList: BrandedAccessList,
  address: BrandedAddress
): boolean
```

**Parameters:**
- `accessList`: Access list to search
- `address`: Address to find

**Returns:** `true` if address is in list

**Example:**
```typescript
import { includesAddressWasm } from './AccessList.wasm.js';

const hasToken = includesAddressWasm(list, tokenAddress);
if (!hasToken) {
  list = list.withAddress(tokenAddress);
}
```

**Performance:**
- Optimized byte-by-byte comparison
- SIMD acceleration where available
- ~2-10x faster for large lists

### includesStorageKeyWasm()

Check if storage key exists using WASM implementation.

```typescript
includesStorageKeyWasm(
  accessList: BrandedAccessList,
  address: BrandedAddress,
  storageKey: BrandedHash
): boolean
```

**Parameters:**
- `accessList`: Access list to search
- `address`: Address to check
- `storageKey`: Storage key to find

**Returns:** `true` if key exists for address

**Example:**
```typescript
import { includesStorageKeyWasm } from './AccessList.wasm.js';

const hasBalance = includesStorageKeyWasm(
  list,
  tokenAddress,
  balanceSlot
);
```

**Performance:**
- Fast address matching then key search
- Optimized for lists with many keys per address
- ~2-10x faster for large lists

## Usage Patterns

### Drop-in Replacement

```typescript
// JavaScript version
const cost = AccessList.gasCost(list);
const savings = AccessList.gasSavings(list);

// WASM version (same API)
const cost = gasCostWasm(list);
const savings = gasSavingsWasm(list);
```

### Conditional WASM Usage

```typescript
import * as AccessListWasm from './AccessList.wasm.js';

function calculateGasCost(
  list: BrandedAccessList,
  useWasm = true
): bigint {
  if (useWasm) {
    try {
      return AccessListWasm.gasCostWasm(list);
    } catch {
      // Fallback to JS if WASM unavailable
    }
  }
  return AccessList.gasCost(list);
}
```

### Hybrid Approach

```typescript
// Use WASM for expensive operations
const cost = gasCostWasm(list);
const hasAddr = includesAddressWasm(list, addr);

// Use JS for cheap operations
const empty = list.isEmpty();
const count = list.addressCount();
```

### Benchmark Comparison

```typescript
function benchmark(list: BrandedAccessList) {
  // JavaScript
  const jsStart = performance.now();
  for (let i = 0; i < 1000; i++) {
    AccessList.gasCost(list);
  }
  const jsTime = performance.now() - jsStart;

  // WASM
  const wasmStart = performance.now();
  for (let i = 0; i < 1000; i++) {
    gasCostWasm(list);
  }
  const wasmTime = performance.now() - wasmStart;

  console.log(`JS: ${jsTime}ms, WASM: ${wasmTime}ms`);
  console.log(`Speedup: ${(jsTime / wasmTime).toFixed(2)}x`);
}
```

## Performance Characteristics

### When to Use WASM

Use WASM when:
- Processing large access lists (10+ items)
- Many storage keys per address (5+ keys)
- High-frequency operations (loops, repeated checks)
- Performance-critical paths

### When to Use JavaScript

Use JavaScript when:
- Small lists (< 5 items)
- Single operations
- WASM module not loaded
- Debugging (better error messages)

### Crossover Points

```typescript
// Small list: JS faster (overhead)
const small = AccessList.create().withAddress(addr);
AccessList.gasCost(small);  // Faster

// Large list: WASM faster
const large = buildComplexList(100, 10);  // 100 addresses, 10 keys each
gasCostWasm(large);  // Faster
```

## Loading WASM

### Automatic Loading

```typescript
// wasm-loader handles initialization
import { gasCostWasm } from './AccessList.wasm.js';

// Ready to use (may be async first call)
const cost = gasCostWasm(list);
```

### Manual Initialization

```typescript
import * as loader from '../../wasm-loader/loader.js';

async function initWasm() {
  await loader.initialize();
  console.log('WASM ready');
}

// Initialize before use
await initWasm();
const cost = gasCostWasm(list);
```

### Error Handling

```typescript
function safeWasmOperation<T>(
  wasmFn: () => T,
  fallbackFn: () => T
): T {
  try {
    return wasmFn();
  } catch (err) {
    console.warn('WASM failed, using fallback:', err);
    return fallbackFn();
  }
}

const cost = safeWasmOperation(
  () => gasCostWasm(list),
  () => AccessList.gasCost(list)
);
```

## Implementation Details

### Zig Backend

WASM functions implemented in Zig for:
- Memory safety
- Zero-cost abstractions
- Manual memory management
- SIMD optimization support

### Data Format

```typescript
// JavaScript passes readonly arrays
const list: BrandedAccessList = [...];

// WASM receives:
// - Array length
// - Pointer to items
// - Item structure:
//   - address: 20-byte array
//   - storageKeys: array of 32-byte arrays
```

### Memory Management

```typescript
// JavaScript manages memory
const list = AccessList.create();  // JS heap

// WASM uses linear memory
gasCostWasm(list);  // Copies to WASM memory, processes, returns result

// No manual cleanup needed
```

## Best Practices

1. **Use WASM for hot paths**
   ```typescript
   // Hot path: called many times
   for (const list of lists) {
     const cost = gasCostWasm(list);  // Use WASM
   }
   ```

2. **Fallback to JavaScript**
   ```typescript
   const cost = (() => {
     try {
       return gasCostWasm(list);
     } catch {
       return AccessList.gasCost(list);
     }
   })();
   ```

3. **Don't mix implementations unnecessarily**
   ```typescript
   // Good: Consistent
   const cost = gasCostWasm(list);
   const savings = gasSavingsWasm(list);

   // Bad: Mixed (no benefit)
   const cost = gasCostWasm(list);
   const savings = AccessList.gasSavings(list);
   ```

4. **Profile before optimizing**
   ```typescript
   // Measure actual performance gain
   const before = performance.now();
   const result = operation(list);
   const after = performance.now();
   console.log(`Time: ${after - before}ms`);
   ```

5. **Handle WASM unavailability**
   ```typescript
   // Environment may not support WASM
   const wasmAvailable = (() => {
     try {
       return typeof WebAssembly !== 'undefined';
     } catch {
       return false;
     }
   })();
   ```

## Benchmarks

### Gas Cost Calculation

```
List Size  | JS (ms) | WASM (ms) | Speedup
-----------|---------|-----------|--------
10 items   | 0.05    | 0.08      | 0.6x
100 items  | 0.5     | 0.2       | 2.5x
1000 items | 5.0     | 1.2       | 4.2x
```

### Address Search

```
List Size  | JS (ms) | WASM (ms) | Speedup
-----------|---------|-----------|--------
10 items   | 0.03    | 0.04      | 0.8x
100 items  | 0.3     | 0.05      | 6.0x
1000 items | 3.0     | 0.3       | 10.0x
```

### Storage Key Search

```
Keys/Item  | JS (ms) | WASM (ms) | Speedup
-----------|---------|-----------|--------
1 key      | 0.05    | 0.06      | 0.8x
10 keys    | 0.5     | 0.1       | 5.0x
100 keys   | 5.0     | 0.5       | 10.0x
```

## See Also

- [Gas Optimization](.gas-optimization) - Gas calculations
- [Queries](.queries) - Query operations
- **[loader.js](https://github.com/evmts/voltaire/blob/main/src/wasm-loader/loader.js)** - WASM initialization