name: CI

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        optimize: [Debug, ReleaseSmall, ReleaseSafe, ReleaseFast]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('**/Cargo.lock') }}
      - name: Clean Zig cache
        shell: bash
        run: rm -rf .zig-cache zig-out ~/.cache/zig target
      - name: Build
        run: zig build -Doptimize=${{ matrix.optimize }}
      - name: Debug - Check library format
        shell: bash
        run: |
          echo "Checking target directory structure:"
          ls -la target/ || true
          ls -la target/debug/ || true
          echo "Checking libcrypto_wrappers.a format:"
          file target/debug/libcrypto_wrappers.a || true
          echo "First bytes of libcrypto_wrappers.a:"
          hexdump -C target/debug/libcrypto_wrappers.a | head -5 || true
      - name: Test
        run: zig build test -Doptimize=${{ matrix.optimize }}

  examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('**/Cargo.lock') }}
      - name: Clean Zig cache
        run: rm -rf .zig-cache zig-out ~/.cache/zig
      - name: Build keccak256 example
        run: zig build example-keccak256
      - name: Build ABI example
        run: zig build example-abi
      - name: Build secp256k1 example
        run: zig build example-secp256k1
      - name: Build address example
        run: zig build example-address
      - name: Build hex example
        run: zig build example-hex
      - name: Build RLP example
        run: zig build example-rlp
      - name: Build EIP-712 example
        run: zig build example-eip712
      - name: Build transaction example
        run: zig build example-transaction
      - name: Build C API example
        run: zig build example-c

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Check formatting
        run: zig fmt --check .
