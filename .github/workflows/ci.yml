name: CI

on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        optimize: [Debug, ReleaseSmall, ReleaseSafe, ReleaseFast]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('**/Cargo.lock') }}
      - name: Clean Zig cache
        shell: bash
        run: rm -rf .zig-cache zig-out ~/.cache/zig target
      - name: Build
        run: zig build -Doptimize=${{ matrix.optimize }}
      - name: Debug - Check library format
        shell: bash
        run: |
          echo "Checking libcrypto_wrappers.a format:"
          file target/debug/libcrypto_wrappers.a || true
          echo "Listing object files in archive:"
          ar t target/debug/libcrypto_wrappers.a | head -10 || true
          echo "Extracting first object file and checking its format:"
          mkdir -p /tmp/ar_extract
          cd /tmp/ar_extract
          ar x /home/runner/work/primitives/primitives/target/debug/libcrypto_wrappers.a $(ar t /home/runner/work/primitives/primitives/target/debug/libcrypto_wrappers.a | head -1) || true
          file * || true
          echo "First object file hex dump:"
          hexdump -C $(ls | head -1) | head -3 || true
      - name: Debug - Check .zig-cache file
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Finding libcrypto_wrappers.a in .zig-cache:"
          find .zig-cache -name "libcrypto_wrappers.a" -type f || true
          echo "Checking format of cached file:"
          find .zig-cache -name "libcrypto_wrappers.a" -type f -exec file {} \; || true
          echo "Hex dump of cached file:"
          find .zig-cache -name "libcrypto_wrappers.a" -type f -exec hexdump -C {} \; | head -5 || true
      - name: Test
        run: zig build test -Doptimize=${{ matrix.optimize }}

  examples:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-v2-${{ hashFiles('**/Cargo.lock') }}
      - name: Clean Zig cache
        run: rm -rf .zig-cache zig-out ~/.cache/zig
      - name: Build keccak256 example
        run: zig build example-keccak256
      - name: Build ABI example
        run: zig build example-abi
      - name: Build secp256k1 example
        run: zig build example-secp256k1
      - name: Build address example
        run: zig build example-address
      - name: Build hex example
        run: zig build example-hex
      - name: Build RLP example
        run: zig build example-rlp
      - name: Build EIP-712 example
        run: zig build example-eip712
      - name: Build transaction example
        run: zig build example-transaction
      - name: Build C API example
        run: zig build example-c

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Zig 0.15.1
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Check formatting
        run: zig fmt --check .
