---
title: How to Simulate a Transaction Before Sending
description: Use eth_call and gas estimation to simulate transactions before execution.
---

## Goal

Simulate a transaction to check for reverts and estimate gas before sending.

## Basic Simulation with eth_call

```ts
import { Address, Hex } from '@voltaire/primitives'
import { Abi } from '@voltaire/primitives/Abi'

// Encode function call
const abi = [
  {
    type: 'function',
    name: 'transfer',
    inputs: [
      { name: 'to', type: 'address' },
      { name: 'amount', type: 'uint256' }
    ],
    outputs: [{ name: '', type: 'bool' }]
  }
] as const

const calldata = Abi.encodeFunction(abi, 'transfer', [
  '0x742d35Cc6634C0532925a3b844Bc9e7595f251e3',
  1000000000000000000n // 1 token
])

// Simulate via eth_call
const result = await provider.request({
  method: 'eth_call',
  params: [{
    from: '0xYourAddress',
    to: '0xTokenContract',
    data: Hex.fromBytes(calldata)
  }, 'latest']
})

// Decode result
const success = Abi.decodeFunction(abi, 'transfer', Hex.toBytes(result))
console.log('Transfer would succeed:', success[0])
```

## Gas Estimation

```ts
// Estimate gas
const gasEstimate = await provider.request({
  method: 'eth_estimateGas',
  params: [{
    from: '0xYourAddress',
    to: '0xTokenContract',
    data: Hex.fromBytes(calldata)
  }]
})

console.log('Estimated gas:', BigInt(gasEstimate))

// Add buffer for safety (10-20%)
const gasLimit = BigInt(gasEstimate) * 120n / 100n
```

## Catch Reverts

```ts
async function simulateTransaction(tx: {
  from: string
  to: string
  data: string
  value?: string
}): Promise<{ success: boolean; result?: string; error?: string }> {
  try {
    const result = await provider.request({
      method: 'eth_call',
      params: [tx, 'latest']
    })
    return { success: true, result }
  } catch (err: any) {
    // Extract revert reason if available
    const message = err.message || String(err)

    // Check for revert data
    if (err.data) {
      const reason = decodeRevertReason(err.data)
      return { success: false, error: reason }
    }

    return { success: false, error: message }
  }
}

// Decode revert reason (see how-to-decode-revert-reason)
function decodeRevertReason(data: string): string {
  // Error(string) selector: 0x08c379a0
  if (data.startsWith('0x08c379a0')) {
    const hex = data.slice(10) // Remove selector
    // Decode string from ABI encoding
    const offset = parseInt(hex.slice(0, 64), 16)
    const length = parseInt(hex.slice(64, 128), 16)
    const strHex = hex.slice(128, 128 + length * 2)
    return Buffer.from(strHex, 'hex').toString('utf8')
  }
  return data
}
```

## Full Simulation Flow

```ts
async function safeTransfer(
  tokenAddress: string,
  to: string,
  amount: bigint
) {
  const calldata = Abi.encodeFunction(erc20Abi, 'transfer', [to, amount])

  // 1. Simulate
  const simulation = await simulateTransaction({
    from: wallet.address,
    to: tokenAddress,
    data: Hex.fromBytes(calldata)
  })

  if (!simulation.success) {
    throw new Error(`Transaction would fail: ${simulation.error}`)
  }

  // 2. Estimate gas
  const gasEstimate = await provider.request({
    method: 'eth_estimateGas',
    params: [{
      from: wallet.address,
      to: tokenAddress,
      data: Hex.fromBytes(calldata)
    }]
  })

  // 3. Execute with gas buffer
  const tx = await wallet.sendTransaction({
    to: tokenAddress,
    data: calldata,
    gasLimit: BigInt(gasEstimate) * 120n / 100n
  })

  return tx
}
```

## See Also

- [Decode Revert Reason](/ghosts/security/how-to-decode-revert-reason)
- [Gas Estimation](/primitives/gas-constants)
