---
title: Encrypt/Decrypt Keystore
description: Encrypt private keys using Web3 Secret Storage (keystore V3)
---

## Encrypt Private Key

```typescript
import * as Keystore from '@voltaire/crypto/Keystore';
import * as PrivateKey from '@voltaire/primitives/PrivateKey';

const privateKey = PrivateKey.from(
  '0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef'
);

// Default encryption (scrypt KDF)
const keystore = await Keystore.encrypt(privateKey, 'my-strong-password');

// Save to file or storage
const json = JSON.stringify(keystore, null, 2);
```

Output:
```json
{
  "version": 3,
  "id": "e4b8a7c2-1234-5678-9abc-def012345678",
  "crypto": {
    "cipher": "aes-128-ctr",
    "ciphertext": "a7b8c9d0e1f2...",
    "cipherparams": { "iv": "1a2b3c4d5e6f..." },
    "kdf": "scrypt",
    "kdfparams": {
      "dklen": 32,
      "n": 262144,
      "r": 8,
      "p": 1,
      "salt": "9a8b7c6d5e4f..."
    },
    "mac": "f1e2d3c4b5a6..."
  }
}
```

## Decrypt Keystore

```typescript
import * as Keystore from '@voltaire/crypto/Keystore';

// Load keystore from file or storage
const keystore = JSON.parse(keystoreJson);

try {
  const privateKey = Keystore.decrypt(keystore, 'my-strong-password');
  console.log('Decrypted successfully');
} catch (error) {
  if (error instanceof Keystore.InvalidMacError) {
    console.error('Wrong password');
  }
}
```

## Encryption Options

<Tabs>
<Tab title="Scrypt (Recommended)">
```typescript
// Memory-hard, GPU-resistant (2-5 seconds)
const keystore = await Keystore.encrypt(privateKey, password, {
  kdf: 'scrypt',
  scryptN: 262144,  // CPU/memory cost
  scryptR: 8,       // Block size
  scryptP: 1        // Parallelization
});
```
</Tab>
<Tab title="PBKDF2 (Faster)">
```typescript
// Faster but less secure against GPU attacks (~500ms)
const keystore = await Keystore.encrypt(privateKey, password, {
  kdf: 'pbkdf2',
  pbkdf2C: 262144  // Iteration count
});
```
</Tab>
</Tabs>

## Security Levels

```typescript
// Fast (testing only) ~50-100ms
const testKeystore = await Keystore.encrypt(privateKey, password, {
  kdf: 'scrypt',
  scryptN: 1024,
  scryptR: 1,
  scryptP: 1
});

// Balanced (mobile/web) ~200-500ms
const mobileKeystore = await Keystore.encrypt(privateKey, password, {
  kdf: 'scrypt',
  scryptN: 16384,
  scryptR: 8,
  scryptP: 1
});

// Maximum (cold storage) ~10-30s
const coldKeystore = await Keystore.encrypt(privateKey, password, {
  kdf: 'scrypt',
  scryptN: 1048576,  // 2^20
  scryptR: 8,
  scryptP: 1
});
```

## Full Wallet Flow

```typescript
import * as Keystore from '@voltaire/crypto/Keystore';
import { Bip39 } from '@voltaire/crypto/Bip39';
import { HDWallet } from '@voltaire/crypto/HDWallet';
import * as PrivateKey from '@voltaire/primitives/PrivateKey';

// Create wallet
const mnemonic = Bip39.generateMnemonic(256);
const seed = await Bip39.mnemonicToSeed(mnemonic);
const root = HDWallet.fromSeed(seed);
const account = HDWallet.deriveEthereum(root, 0);
const privateKey = HDWallet.getPrivateKey(account);
const address = PrivateKey.toAddress(privateKey);

// Encrypt for storage
const keystore = await Keystore.encrypt(privateKey, userPassword);

// Store keystore (localStorage, file, etc)
localStorage.setItem(`wallet:${address}`, JSON.stringify(keystore));

// Later: unlock wallet
const stored = JSON.parse(localStorage.getItem(`wallet:${address}`));
const unlockedKey = Keystore.decrypt(stored, userPassword);
```

## Error Handling

All Keystore errors extend `CryptoError` and include structured metadata:

```typescript
try {
  const privateKey = Keystore.decrypt(keystore, password);
} catch (error) {
  if (error instanceof Keystore.InvalidMacError) {
    // Wrong password or corrupted keystore
    console.error(error.name);  // "InvalidMacError"
    console.error(error.code);  // "INVALID_MAC"
  } else if (error instanceof Keystore.UnsupportedVersionError) {
    // Only version 3 supported
    console.error(error.name);     // "UnsupportedVersionError"
    console.error(error.code);     // "UNSUPPORTED_VERSION"
    console.error(error.version);  // The unsupported version
  } else if (error instanceof Keystore.UnsupportedKdfError) {
    // Only scrypt and pbkdf2 supported
    console.error(error.name);  // "UnsupportedKdfError"
    console.error(error.code);  // "UNSUPPORTED_KDF"
    console.error(error.kdf);   // The unsupported KDF
  }
}
```

### Error Types

| Error Class | Code | Description |
|-------------|------|-------------|
| `KeystoreError` | `KEYSTORE_ERROR` | Base error for all keystore operations |
| `InvalidMacError` | `INVALID_MAC` | MAC verification failed (wrong password) |
| `UnsupportedVersionError` | `UNSUPPORTED_VERSION` | Keystore version not v3 |
| `UnsupportedKdfError` | `UNSUPPORTED_KDF` | KDF not scrypt/pbkdf2 |
| `DecryptionError` | `DECRYPTION_ERROR` | Decryption failed |
| `EncryptionError` | `ENCRYPTION_ERROR` | Encryption failed |

## Related

- [Keystore Encryption](/crypto/keystore/encryption) - Detailed encryption docs
- [Keystore Decryption](/crypto/keystore/decryption) - Detailed decryption docs
- [Keystore Security](/crypto/keystore/security) - Security considerations
