---
title: '[TS/JS] voltaire-effect/src/auth/siwe.test.ts'
source: 'voltaire-effect/src/auth/siwe.test.ts'
---

> Auto-generated from test file: voltaire-effect/src/auth/siwe.test.ts

```typescript
import { describe, expect, it } from "@effect/vitest";
import { Address } from "@tevm/voltaire/Address";
import type { HashType } from "@tevm/voltaire/Hash";
import * as Effect from "effect/Effect";
import * as Exit from "effect/Exit";
import { CryptoLive } from "../crypto/CryptoLive.js";
import * as Secp256k1 from "../crypto/Secp256k1/index.js";
import { hashMessage } from "../crypto/Signature/hashMessage.js";
import {
	createSiweMessage,
	parseSiweMessage,
	VerifyError,
	verifySiweMessage,
} from "./siwe.js";

const hexToBytes = (hex: string): Uint8Array => {
	const normalized = hex.startsWith("0x") ? hex.slice(2) : hex;
	const bytes = new Uint8Array(normalized.length / 2);
	for (let i = 0; i < bytes.length; i++) {
		bytes[i] = Number.parseInt(normalized.slice(i * 2, i * 2 + 2), 16);
	}
	return bytes;
};

describe("createSiweMessage", () => {
	it("formats an EIP-4361 message", () => {
		const address = Address.fromHex(
			"0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
		);
		const message = createSiweMessage({
			domain: "example.com",
			address,
			uri: "https://example.com/login",
			chainId: 1,
			statement: "Welcome to Example.com",
			nonce: "32891756",
			issuedAt: "2021-09-30T16:25:24Z",
			resources: ["https://example.com/resource1", "ipfs://Qmxxx"],
		});

		const expected = `example.com wants you to sign in with your Ethereum account:
0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2

Welcome to Example.com

URI: https://example.com/login
Version: 1
Chain ID: 1
Nonce: 32891756
Issued At: 2021-09-30T16:25:24Z
Resources:
- https://example.com/resource1
- ipfs://Qmxxx`;

		expect(message).toBe(expected);
	});
});

describe("parseSiweMessage", () => {
	it.effect("parses a real SIWE message", () =>
		Effect.gen(function* () {
			const text = `example.com wants you to sign in with your Ethereum account:
0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2

Welcome to Example.com

URI: https://example.com
Version: 1
Chain ID: 1
Nonce: 32891756
Issued At: 2021-09-30T16:25:24Z
Expiration Time: 2021-10-01T16:25:24Z
Not Before: 2021-09-30T16:00:00Z
Request ID: request-abc123
Resources:
- https://example.com/resource1
- ipfs://Qmxxx`;

			const parsed = yield* parseSiweMessage(text);
			expect(parsed.domain).toBe("example.com");
			expect(parsed.statement).toBe("Welcome to Example.com");
			expect(parsed.chainId).toBe(1);
			expect(parsed.nonce).toBe("32891756");
			expect(parsed.address).toBeInstanceOf(Uint8Array);
			expect(parsed.address.length).toBe(20);
			expect(parsed.resources).toEqual([
				"https://example.com/resource1",
				"ipfs://Qmxxx",
			]);
		}),
	);
});

describe("verifySiweMessage", () => {
	const privateKeyHex =
		"0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef";

	const createSignedMessage = () =>
		Effect.gen(function* () {
			const privateKey = hexToBytes(privateKeyHex);
			const address = Address.fromPrivateKey(privateKey);
			const message = createSiweMessage({
				domain: "example.com",
				address,
				uri: "https://example.com/login",
				chainId: 1,
				nonce: "12345678",
				issuedAt: "2021-09-30T16:25:24Z",
			});
			const hash = yield* hashMessage(message);
			const signature = yield* Secp256k1.sign(
				hash as unknown as HashType,
				privateKey as Parameters<typeof Secp256k1.sign>[1],
			);
			return { message, signature, address };
		});

	it.effect("verifies a valid SIWE message and signature", () =>
		Effect.gen(function* () {
			const { message, signature, address } = yield* createSignedMessage();
			const result = yield* verifySiweMessage({
				message,
				signature,
				address,
				domain: "example.com",
				nonce: "12345678",
			});

			expect(result.domain).toBe("example.com");
			expect(result.nonce).toBe("12345678");
		}).pipe(Effect.provide(CryptoLive)),
	);

	it.effect("fails verification when nonce mismatches", () =>
		Effect.gen(function* () {
			const { message, signature, address } = yield* createSignedMessage();
			const exit = yield* Effect.exit(
				verifySiweMessage({
					message,
					signature,
					address,
					domain: "example.com",
					nonce: "wrongnonce",
				}),
			);
			expect(Exit.isFailure(exit)).toBe(true);
			if (Exit.isFailure(exit)) {
				const cause = exit.cause;
				expect(cause._tag).toBe("Fail");
				if (cause._tag === "Fail") {
					expect(cause.error).toBeInstanceOf(VerifyError);
				}
			}
		}).pipe(Effect.provide(CryptoLive)),
	);
});

```
