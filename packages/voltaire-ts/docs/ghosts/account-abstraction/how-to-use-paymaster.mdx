---
title: How to Sponsor Gas with Paymaster
description: Use ERC-4337 paymasters for gasless transactions and token-based gas payment.
---

## Overview

Paymasters are contracts that sponsor gas for UserOperations. They enable:
- **Gasless UX** - Users don't need ETH for gas
- **Token payments** - Pay gas in ERC-20 tokens
- **Subscription models** - Prepaid gas sponsorship
- **Conditional sponsorship** - Whitelist-based or rule-based

## Paymaster Types

| Type | Description |
|------|-------------|
| Verifying Paymaster | Validates off-chain signature from paymaster service |
| Token Paymaster | Accepts ERC-20 tokens as gas payment |
| Deposit Paymaster | Uses user deposits for gas |
| Sponsoring Paymaster | Unconditionally sponsors gas |

## Using a Verifying Paymaster

Most common pattern - paymaster service provides signature:

```typescript
import { Paymaster } from '@tevm/voltaire/primitives/Paymaster';
import { Hex } from '@tevm/voltaire/Hex';

// 1. Create UserOp without paymasterAndData
const unsignedUserOp = UserOperation.from({
  sender: smartAccountAddress,
  nonce: 0n,
  initCode: '0x',
  callData: encodedCallData,
  callGasLimit: 100000n,
  verificationGasLimit: 150000n,
  preVerificationGas: 50000n,
  maxFeePerGas: 30000000000n,
  maxPriorityFeePerGas: 1000000000n,
  paymasterAndData: '0x', // Empty initially
  signature: '0x',
});

// 2. Request sponsorship from paymaster service
const sponsorshipResponse = await fetch(paymasterServiceUrl, {
  method: 'POST',
  body: JSON.stringify({
    userOperation: unsignedUserOp,
    entryPoint: entryPointAddress,
    chainId: chainId,
  }),
});

const { paymasterAndData } = await sponsorshipResponse.json();

// 3. Add paymasterAndData to UserOp
const sponsoredUserOp = {
  ...unsignedUserOp,
  paymasterAndData,
};
```

## paymasterAndData Format

```
paymasterAndData = paymaster (20 bytes) + paymasterData (variable)
```

Common structures:

```typescript
// Verifying paymaster with time bounds
const paymasterAndData = Hex.concat([
  paymasterAddress,          // 20 bytes
  validUntil,                // 6 bytes (uint48)
  validAfter,                // 6 bytes (uint48)
  paymasterSignature,        // 65 bytes (r + s + v)
]);

// Token paymaster with token address
const paymasterAndData = Hex.concat([
  paymasterAddress,          // 20 bytes
  tokenAddress,              // 20 bytes
  maxTokenAmount,            // 32 bytes
]);
```

## Paymaster RPC Methods (pm_ namespace)

Some bundlers expose paymaster-specific methods:

```typescript
// Get paymaster data for UserOp
const result = await bundlerClient.request({
  method: 'pm_sponsorUserOperation',
  params: [userOp, entryPointAddress],
});
// Returns: { paymasterAndData, preVerificationGas, verificationGasLimit, callGasLimit }

// Get paymaster stub for gas estimation
const stub = await bundlerClient.request({
  method: 'pm_getPaymasterStubData',
  params: [userOp, entryPointAddress],
});
```

## Token Paymaster Flow

Pay gas with ERC-20 tokens:

```typescript
// 1. Approve paymaster to spend tokens
const approveCalldata = Abi.encodeFunction({
  abi: erc20Abi,
  functionName: 'approve',
  args: [tokenPaymasterAddress, maxUint256],
});

// 2. Include token info in paymasterAndData
const tokenPaymasterData = Hex.concat([
  tokenPaymasterAddress,
  tokenAddress,
  Hex.fromBigInt(maxTokenCost, { size: 32 }),
]);

const userOp = UserOperation.from({
  // ... other fields
  paymasterAndData: tokenPaymasterData,
});

// Token deducted from sender during postOp
```

## Paymaster Verification Flow

EntryPoint calls paymaster during validation:

```solidity
// Paymaster interface
function validatePaymasterUserOp(
    UserOperation calldata userOp,
    bytes32 userOpHash,
    uint256 maxCost
) external returns (bytes memory context, uint256 validationData);

function postOp(
    PostOpMode mode,
    bytes calldata context,
    uint256 actualGasCost,
    uint256 actualUserOpFeePerGas
) external;
```

## Checking Paymaster Deposit

Paymasters must maintain deposit in EntryPoint:

```typescript
const deposit = await publicClient.readContract({
  address: entryPointAddress,
  abi: entryPointAbi,
  functionName: 'getDepositInfo',
  args: [paymasterAddress],
});

console.log('Paymaster deposit:', deposit.deposit);
console.log('Staked:', deposit.staked);
```

## Error Codes

| Code | Meaning |
|------|---------|
| AA30 | Paymaster not deployed |
| AA31 | Paymaster deposit too low |
| AA32 | Paymaster expired (validUntil) |
| AA33 | Reverted in postOp |
| AA34 | Paymaster validation OOG |

## Popular Paymaster Services

| Provider | Features |
|----------|----------|
| Pimlico | Verifying + ERC-20 |
| Alchemy | Gas Manager API |
| Stackup | Sponsorship policies |
| Biconomy | Token + verifying |
| ZeroDev | Programmable policies |

## Related

- [Create UserOperation](/ghosts/account-abstraction/how-to-create-useroperation)
- [Submit to Bundler](/ghosts/account-abstraction/how-to-submit-to-bundler)
- [Paymaster Reference](/primitives/paymaster)
