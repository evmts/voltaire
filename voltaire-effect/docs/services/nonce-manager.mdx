---
title: NonceManager Service
description: Transaction nonce management for concurrent transactions with Effect.ts
---

## Quick Start

```typescript
import { Effect } from 'effect'
import { NonceManagerService, DefaultNonceManager, Provider, HttpTransport } from 'voltaire-effect/services'

const program = Effect.gen(function* () {
  const nonceManager = yield* NonceManagerService
  const chainId = 1
  
  // Consume nonce for transaction
  const nonce = yield* nonceManager.consume('0x1234...', chainId)
  return nonce
}).pipe(
  Effect.provide(DefaultNonceManager),
  Effect.provide(Provider),
  Effect.provide(HttpTransport('https://eth.llamarpc.com'))
)
```

## Why NonceManager?

When sending multiple transactions quickly, you can't wait for each to be mined before getting the next nonce. The NonceManager tracks a local delta per address/chain, allowing concurrent transaction preparation without nonce collisions.

```typescript
const program = Effect.gen(function* () {
  const nonceManager = yield* NonceManagerService
  const address = '0x1234...'
  const chainId = 1

  // Get nonces for 3 concurrent transactions
  const nonce1 = yield* nonceManager.consume(address, chainId) // e.g., 5
  const nonce2 = yield* nonceManager.consume(address, chainId) // e.g., 6
  const nonce3 = yield* nonceManager.consume(address, chainId) // e.g., 7

  // Send transactions with these nonces...

  // After all confirmed, reset to resync with chain
  yield* nonceManager.reset(address, chainId)
})
```

## Methods

### get

Returns the current nonce without consuming it (on-chain pending + local delta).

```typescript
const nonce = yield* nonceManager.get('0x1234...', 1)
```

### consume

Gets and atomically increments the nonce. Safe for concurrent calls.

```typescript
const nonce = yield* nonceManager.consume('0x1234...', 1)
// Use nonce in transaction, delta is incremented
```

### increment

Increments the local delta without fetching from chain. Use when a transaction was sent externally.

```typescript
yield* nonceManager.increment('0x1234...', 1)
```

### reset

Clears the local delta for an address/chain. Call after transactions confirm to resync.

```typescript
yield* nonceManager.reset('0x1234...', 1)
```

## Error Handling

```typescript
import { NonceError } from 'voltaire-effect/services'

program.pipe(
  Effect.catchTag('NonceError', (e) => {
    console.error(`Nonce error for ${e.address}: ${e.message}`)
    return Effect.succeed(0)
  })
)
```

## Layer Composition

```typescript
import { Layer } from 'effect'
import { DefaultNonceManager, Provider, HttpTransport } from 'voltaire-effect/services'

const MainnetNonceManager = DefaultNonceManager.pipe(
  Layer.provideMerge(Provider),
  Layer.provide(HttpTransport('https://eth.llamarpc.com'))
)

const program = myEffect.pipe(Effect.provide(MainnetNonceManager))
```

## Service Interface

```typescript
type NonceManagerShape = {
  readonly get: (
    address: string,
    chainId: number
  ) => Effect.Effect<number, NonceError, ProviderService>

  readonly consume: (
    address: string,
    chainId: number
  ) => Effect.Effect<number, NonceError, ProviderService>

  readonly increment: (
    address: string,
    chainId: number
  ) => Effect.Effect<void>

  readonly reset: (
    address: string,
    chainId: number
  ) => Effect.Effect<void>
}
```
