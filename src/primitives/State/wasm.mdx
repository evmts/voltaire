---
title: State WASM
description: WebAssembly implementation details for State primitive
---

# WASM Implementation

The State primitive provides WebAssembly-optimized operations compiled from Zig for high-performance state management.

## Overview

State operations (hashing, comparison) are implemented in both TypeScript and Zig/WASM:

- **TypeScript**: Pure JavaScript implementation, universal compatibility
- **Zig/WASM**: High-performance compiled code for intensive operations

The library automatically selects the best implementation based on environment.

## WASM Operations

### Hash Code Calculation

```typescript
// WASM-optimized hash code for StorageKey
import { hashCode } from '@tevm/primitives/State'

const key = State.StorageKey(contractAddr, 42n)
const hash = hashCode(key)  // Uses WASM if available

// Deterministic numeric hash for:
// - Hash map bucketing
// - Bloom filter indexing
// - Cache sharding
```

### String Serialization

```typescript
// Efficient string conversion
import { toString } from '@tevm/primitives/State'

const keyStr = toString(key)  // Optimized path

// Format: "0xaddress:slot"
// WASM optimizes hex encoding and concatenation
```

## Build Modes

State WASM is built in two optimization modes:

### ReleaseSmall (Default)

Optimized for bundle size:

```bash
zig build build-ts-wasm
```

Output: `wasm/primitives.wasm` (~50-100 KB for all primitives)

**Use for:**
- Production web applications
- Mobile apps (bundle size critical)
- Serverless functions (cold start sensitive)

### ReleaseFast (Performance)

Optimized for maximum performance:

```bash
zig build build-ts-wasm-fast
```

Output: `wasm/primitives-fast.wasm` (~200-400 KB)

**Use for:**
- Node.js servers
- CLI tools
- Data processing pipelines
- Blockchain indexers

## Performance Characteristics

| Operation | TypeScript | WASM (Small) | WASM (Fast) | Speedup |
|-----------|------------|--------------|-------------|---------|
| hashCode | ~50 ns | ~30 ns | ~15 ns | 1.7-3.3x |
| toString | ~200 ns | ~120 ns | ~80 ns | 1.7-2.5x |
| fromString | ~300 ns | ~180 ns | ~100 ns | 1.7-3x |
| equals | ~80 ns | ~40 ns | ~20 ns | 2-4x |

*Benchmarks on M1 Mac, single operation. Actual speedup varies by environment.*

## Loading WASM

The library handles WASM loading automatically:

```typescript
// Automatically uses WASM when available
import * as State from '@tevm/primitives/State'

const key = State.StorageKey(addr, 0n)
const hash = State.StorageKey.hashCode(key)  // WASM if loaded
```

### Manual WASM Control

```typescript
// Disable WASM (TypeScript only)
import { setWasmEnabled } from '@tevm/primitives/State'

setWasmEnabled(false)

// Re-enable WASM
setWasmEnabled(true)

// Check if WASM is available
import { isWasmAvailable } from '@tevm/primitives/State'

if (isWasmAvailable()) {
  console.log('Using WASM-accelerated State operations')
}
```

### Preload WASM

For better startup performance, preload WASM:

```typescript
import { initWasm } from '@tevm/primitives/State'

// Preload at app startup
await initWasm()

// Now all operations use WASM
const hash = State.StorageKey.hashCode(key)
```

## Bundle Size Impact

State primitive bundle sizes (gzipped):

| Import | TypeScript Only | + WASM (Small) | + WASM (Fast) |
|--------|-----------------|----------------|---------------|
| StorageKey only | ~1 KB | ~15 KB | ~50 KB |
| Full State | ~2 KB | ~16 KB | ~52 KB |

**Recommendation**: Use ReleaseSmall for web, ReleaseFast for Node.js.

## Tree-Shaking

Import only needed functions to minimize bundle size:

```typescript
// Import only what you need
import { StorageKey, toString, hashCode } from '@tevm/primitives/State'

// WASM automatically tree-shaken if not used
```

## Memory Usage

WASM module memory footprint:

- **Initial**: ~64 KB (single WASM page)
- **Maximum**: ~1 MB (grows as needed)
- **Per-operation**: 0 allocations (stack-only)

State operations don't allocate WASM memory - all processing happens on the stack.

## Compatibility

WASM support matrix:

| Environment | WASM Support | Fallback |
|-------------|--------------|----------|
| Chrome 57+ | ✅ Full | - |
| Firefox 52+ | ✅ Full | - |
| Safari 11+ | ✅ Full | - |
| Edge 79+ | ✅ Full | - |
| Node.js 12+ | ✅ Full | - |
| Deno 1.0+ | ✅ Full | - |
| Bun 0.1+ | ✅ Full | - |
| React Native | ⚠️ Partial | TypeScript |
| Older browsers | ❌ None | TypeScript |

When WASM is unavailable, the library automatically falls back to TypeScript implementation.

## Testing WASM

Run WASM-specific tests:

```bash
# Test WASM build
zig build test-ts-wasm

# Compare WASM vs TypeScript
bun run test -- wasm
```

## Benchmarking

Compare WASM vs TypeScript performance:

```bash
# Run State benchmarks
zig build bench -Dbench-filter=state

# TypeScript benchmarks
bun run bench -- state
```

## WASM Source

Zig implementation: `src/primitives/state.zig`

Key functions:
- `storageKeyHash()` - Compute hash code
- `storageKeyEquals()` - Compare keys
- `storageKeyToString()` - Serialize to string
- `storageKeyFromString()` - Parse from string

## Debugging WASM

Enable WASM debug logging:

```typescript
import { setWasmDebug } from '@tevm/primitives/State'

setWasmDebug(true)

// Now logs WASM calls and performance
const hash = State.StorageKey.hashCode(key)
// LOG: [WASM] hashCode: 42ns
```

## Production Recommendations

### Web Applications

```typescript
// Use ReleaseSmall for bundle size
import * as State from '@tevm/primitives/State'

// Preload WASM at app init
await State.initWasm()

// All operations now use WASM
```

### Node.js Services

```typescript
// Use ReleaseFast for maximum performance
import * as State from '@tevm/primitives/State'

// WASM loads automatically on first use
const key = State.StorageKey(addr, 0n)
```

### Mobile/Embedded

```typescript
// Disable WASM to save bundle size
import { setWasmEnabled } from '@tevm/primitives/State'

setWasmEnabled(false)

// TypeScript-only implementation (smaller bundle)
```

## Related

- [WASM Loader](/wasm-loader) - WASM infrastructure
- [Benchmarking](/benchmarking) - Performance comparisons
- [Zig Implementation](/primitives/state/state.zig) - Source code
