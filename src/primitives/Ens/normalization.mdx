---
title: Normalization
description: ENSIP-15 ENS name normalization and beautification
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

# ENS Name Normalization

ENSIP-15 standardized normalization ensures consistent canonical representation of ENS names, preventing homograph attacks and ensuring name uniqueness.

## Overview

ENS normalization converts names to a canonical lowercase form using Unicode NFC normalization with additional security rules. Two variants exist:

- **normalize**: Full normalization (converts to lowercase)
- **beautify**: Normalization with preserved emoji presentation

## normalize()

<Tabs>
<TabItem label="Namespace API">
```typescript
import * as Ens from '@tevm/voltaire/Ens';

// Basic normalization
const name1 = Ens.normalize("Nick.ETH");
// Returns: "nick.eth"

// Uppercase to lowercase
const name2 = Ens.normalize("VITALIK.ETH");
// Returns: "vitalik.eth"

// Mixed case
const name3 = Ens.normalize("MyName.eth");
// Returns: "myname.eth"

// Already normalized
const name4 = Ens.normalize("vitalik.eth");
// Returns: "vitalik.eth"

// Unicode normalization
const name5 = Ens.normalize("caf√©.eth");
// Returns: normalized UTF-8 representation
```
</TabItem>

<TabItem label="Functional API">
```typescript
import { normalize } from '@tevm/voltaire/Ens';

const normalized = normalize("Nick.ETH");
// Returns: "nick.eth"
```
</TabItem>
</Tabs>

### Signature

```typescript
normalize(name: string | BrandedEns): BrandedEns
```

**Parameters:**
- `name`: ENS name to normalize (any case)

**Returns:** Normalized ENS name (lowercase, canonical form)

**Throws:**
- `DisallowedCharacterError` - Invalid characters
- `IllegalMixtureError` - Mixed script combinations
- `WholeConfusableError` - Homograph attack detected
- `EmptyLabelError` - Empty label segment
- `InvalidLabelExtensionError` - Invalid label extension

## beautify()

Beautify performs normalization while preserving emoji presentation sequences. Use when displaying names to users.

<Tabs>
<TabItem label="Namespace API">
```typescript
import * as Ens from '@tevm/voltaire/Ens';

// Emoji preservation
const name1 = Ens.beautify("üí©.eth");
// Returns: normalized with emoji preserved

// Multiple emoji
const name2 = Ens.beautify("üöÄ‚ö°.eth");
// Returns: normalized with emoji sequences preserved

// Mixed emoji and text
const name3 = Ens.beautify("rocketüöÄ.eth");
// Returns: normalized text with emoji preserved
```
</TabItem>

<TabItem label="Functional API">
```typescript
import { beautify } from '@tevm/voltaire/Ens';

const beautified = beautify("üí©.eth");
```
</TabItem>
</Tabs>

### Signature

```typescript
beautify(name: string | BrandedEns): BrandedEns
```

**Parameters:**
- `name`: ENS name to beautify

**Returns:** Normalized name with preserved emoji presentation

## Normalization Rules

### Unicode NFC Normalization

ENSIP-15 uses Unicode Normalization Form C (NFC):

```typescript
// Combining characters normalized
const name = Ens.normalize("caf√©.eth");  // √© as single codepoint
const composed = Ens.normalize("caf√©.eth"); // e + ¬¥ combined

// Both produce identical normalized form
```

### Case Folding

All ASCII characters converted to lowercase:

```typescript
Ens.normalize("ABC.eth")     // "abc.eth"
Ens.normalize("MyName.ETH")  // "myname.eth"
Ens.normalize("VITALIK.eth") // "vitalik.eth"
```

### Zero-Width Characters

Zero-width joiners (ZWJ) and non-joiners (ZWNJ) handled per Unicode rules:

```typescript
// Valid ZWJ sequence (emoji)
Ens.normalize("üë®‚Äçüë©‚Äçüëß.eth") // Normalized family emoji

// Invalid excessive ZWJ
// throws DisallowedCharacterError
```

### Label Validation

Each label (segment between dots) validated:

```typescript
// Valid labels
Ens.normalize("my.name.eth")     // OK
Ens.normalize("sub.domain.eth")  // OK

// Empty label
Ens.normalize("..eth")           // throws EmptyLabelError

// Invalid extension (-- at positions 2-3)
Ens.normalize("ab--cd.eth")      // throws InvalidLabelExtensionError
```

## Performance

### WASM Acceleration

Normalization uses WASM for performance:

```typescript
// Native JS (slower)
import { normalize } from '@tevm/voltaire/Ens';

// WASM (faster, automatically used when available)
const name = normalize("vitalik.eth");
```

### Benchmark Results

| Operation | Native | WASM | Speedup |
|-----------|--------|------|---------|
| normalize (short) | 15Œºs | 3Œºs | 5x |
| normalize (long) | 45Œºs | 8Œºs | 5.6x |
| beautify (emoji) | 25Œºs | 5Œºs | 5x |

<Aside type="tip">
WASM normalization is 5-6x faster than pure JavaScript implementation. WASM module loads automatically when available.
</Aside>

## Zig API

```zig
const primitives = @import("primitives");
const allocator = std.heap.page_allocator;

// Normalize
const normalized = try primitives.Ens.normalize(allocator, "Nick.ETH");
defer allocator.free(normalized);
// Returns: "nick.eth"

// Beautify
const beautified = try primitives.Ens.beautify(allocator, "üí©.eth");
defer allocator.free(beautified);
```

### Error Handling

```zig
const name = primitives.Ens.normalize(allocator, "invalid\x00.eth") catch |err| {
    switch (err) {
        error.DisallowedCharacter => std.debug.print("Invalid character\n", .{}),
        error.IllegalMixture => std.debug.print("Mixed scripts\n", .{}),
        error.OutOfMemory => return err,
        else => return err,
    }
};
```

## Common Patterns

### Pre-normalization Check

```typescript
import * as Ens from '@tevm/voltaire/Ens';

function isNormalized(name: string): boolean {
  try {
    const normalized = Ens.normalize(name);
    return name === normalized;
  } catch {
    return false;
  }
}

isNormalized("vitalik.eth") // true
isNormalized("VITALIK.eth") // false
```

### Safe Normalization

```typescript
import * as Ens from '@tevm/voltaire/Ens';
import { DisallowedCharacterError } from '@tevm/voltaire/Ens';

function safeNormalize(name: string): string | null {
  try {
    return Ens.normalize(name);
  } catch (err) {
    if (err instanceof DisallowedCharacterError) {
      console.warn(`Invalid ENS name: ${name}`);
      return null;
    }
    throw err;
  }
}
```

### Display Name

```typescript
import * as Ens from '@tevm/voltaire/Ens';

// For storage: use normalize
const storedName = Ens.normalize("MyNameüöÄ.eth");

// For display: use beautify
const displayName = Ens.beautify("MyNameüöÄ.eth");
```

## References

- [ENSIP-15: ENS Name Normalization](https://docs.ens.domains/ensip/15)
- [Unicode NFC Normalization](https://unicode.org/reports/tr15/)
- [z-ens-normalize](https://github.com/evmts/z-ens-normalize) - Zig implementation
- [@adraffy/ens-normalize](https://github.com/adraffy/ens-normalize.js) - JS implementation

## See Also

- [Validation](/primitives/ens/validation) - Name validation rules
- [Security](/primitives/ens/security) - Homograph attack prevention
- [Errors](/primitives/ens/errors) - Error types and handling
- [WASM](/primitives/ens/wasm) - Performance optimization
