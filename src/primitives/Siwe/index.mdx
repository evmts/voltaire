# Siwe

Sign-In with Ethereum (EIP-4361) implementation for decentralized authentication.

## Overview

SIWE provides standardized Ethereum account authentication. Creates structured messages users sign with private keys, proving address ownership without key exposure.

## Factory

```typescript
Siwe(params: MessageParams): Siwe
```

Creates Siwe message instance from parameters.

**Parameters:**
- `params.domain`: RFC 4501 dns authority
- `params.address`: BrandedAddress performing signing
- `params.uri`: RFC 3986 URI
- `params.chainId`: EIP-155 Chain ID
- `params.statement?`: Human-readable assertion (optional)
- `params.expirationTime?`: ISO 8601 expiration (optional)
- `params.notBefore?`: ISO 8601 valid-from time (optional)
- `params.requestId?`: System identifier (optional)
- `params.resources?`: Resource URIs (optional)
- `params.nonce?`: Custom nonce (auto-generated if omitted)
- `params.issuedAt?`: Custom timestamp (current time if omitted)

**Returns:** Siwe message instance

## Static Constructors

### [Siwe.create(params)](./constructors.mdx#create)
```typescript
create(params: MessageParams): BrandedMessage
```
Create message with defaults. Same as factory.

### [Siwe.parse(text)](./parsing.mdx#parse)
```typescript
parse(text: string): BrandedMessage
```
Parse EIP-4361 formatted string to message.

**Throws:** Error if format invalid

## Static Utilities

### Formatting

#### [Siwe.format(message)](./parsing.mdx#format)
```typescript
format(message: BrandedMessage): string
```
Format message to EIP-4361 string for signing.

### Validation

#### [Siwe.validate(message, options?)](./validation.mdx)
```typescript
validate(message: BrandedMessage, options?: { now?: Date }): ValidationResult
```
Validate message structure and timestamps.

**Returns:** `{ valid: true }` or `{ valid: false, error: ValidationError }`

### Signing & Verification

#### [Siwe.getMessageHash(message)](./signing.mdx)
```typescript
getMessageHash(message: BrandedMessage): Uint8Array
```
Get EIP-191 personal sign message hash (32 bytes).

#### [Siwe.verify(message, signature)](./verification.mdx)
```typescript
verify(message: BrandedMessage, signature: Signature): boolean
```
Verify signature matches message address.

**Parameters:**
- `signature`: 65-byte signature (r + s + v)

**Returns:** true if valid

#### [Siwe.verifyMessage(message, signature, options?)](./verification.mdx#verifymessage)
```typescript
verifyMessage(message: BrandedMessage, signature: Signature, options?: { now?: Date }): ValidationResult
```
Combined validation and verification.

### Nonce Generation

#### [Siwe.generateNonce(length?)](./utilities.mdx#generatenonce)
```typescript
generateNonce(length?: number): string
```
Generate cryptographically secure random nonce.

**Parameters:**
- `length`: Nonce length (default 11, min 8)

**Returns:** Base62 alphanumeric string

## Instance Methods

All static utilities available as instance methods:

```typescript
const message = Siwe.create({
  domain: "example.com",
  address: userAddress,
  uri: "https://example.com",
  chainId: 1,
});

message.format()           // string
message.validate()         // ValidationResult
message.getMessageHash()   // Uint8Array
message.verify(signature)  // boolean
```

Instance methods delegate to BrandedSiwe namespace functions.

## Types

```typescript
type BrandedMessage = {
  domain: string;
  address: BrandedAddress;
  uri: string;
  version: string;
  chainId: number;
  nonce: string;
  issuedAt: string;
  statement?: string;
  expirationTime?: string;
  notBefore?: string;
  requestId?: string;
  resources?: string[];
}

type Signature = Uint8Array;  // 65 bytes: r (32) + s (32) + v (1)

type ValidationResult =
  | { valid: true }
  | { valid: false; error: ValidationError };

type ValidationError =
  | { type: "invalid_domain"; message: string }
  | { type: "invalid_address"; message: string }
  | { type: "invalid_uri"; message: string }
  | { type: "invalid_version"; message: string }
  | { type: "invalid_chain_id"; message: string }
  | { type: "invalid_nonce"; message: string }
  | { type: "invalid_timestamp"; message: string }
  | { type: "expired"; message: string }
  | { type: "not_yet_valid"; message: string }
  | { type: "signature_mismatch"; message: string };
```

See [BrandedSiwe](./branded-siwe.mdx) for branded type details.

## Implementation

- Delegates to BrandedSiwe namespace
- Extends Object.prototype
- Structured message format per EIP-4361
- Supports optional fields via conditional spreading

## Quick Start

```typescript
import { Siwe, Address } from '@tevm/voltaire';

// Create message
const message = Siwe.create({
  domain: "example.com",
  address: Address.fromHex("0x..."),
  uri: "https://example.com/login",
  chainId: 1,
  statement: "Sign in to Example App",
});

// Format for wallet signing
const text = message.format();

// User signs with wallet
const signature = await wallet.signMessage(text);

// Validate and verify
const result = Siwe.verifyMessage(message, signature);
if (result.valid) {
  // Authenticated
}
```

## Common Patterns

### Authentication Flow

```typescript
// Backend: Generate nonce
const nonce = Siwe.generateNonce();
storeNonce(userId, nonce);

// Frontend: Create and sign message
const message = Siwe.create({
  domain: window.location.host,
  address: userAddress,
  uri: window.location.origin,
  chainId: await provider.getChainId(),
  nonce,
});
const signature = await wallet.signMessage(message.format());

// Backend: Verify
const parsed = Siwe.parse(messageText);
const result = Siwe.verifyMessage(parsed, signature);
if (result.valid && verifyNonce(parsed.nonce)) {
  createSession(parsed.address);
}
```

### Session Management

```typescript
const message = Siwe.create({
  domain: "example.com",
  address: userAddress,
  uri: "https://example.com",
  chainId: 1,
  expirationTime: new Date(Date.now() + 3600000).toISOString(),
});

// Validate at session use
const result = message.validate({ now: new Date() });
if (!result.valid) {
  requestReauth();
}
```

## References

- [EIP-4361: Sign-In with Ethereum](https://eips.ethereum.org/EIPS/eip-4361)
- [EIP-191: Signed Data Standard](https://eips.ethereum.org/EIPS/eip-191)
- [Constructors](./constructors.mdx)
- [Parsing](./parsing.mdx)
- [Validation](./validation.mdx)
- [Signing](./signing.mdx)
- [Verification](./verification.mdx)
- [Utilities](./utilities.mdx)
- [Usage Patterns](./usage-patterns.mdx)
- [WASM](./wasm.mdx)
