# WASM Implementation

WebAssembly-accelerated blob operations via Zig implementation.

## Overview

Blob.wasm.ts provides WASM bindings to Zig implementation for performance-critical operations:

- Data encoding/decoding
- Size validation
- Gas calculations
- Blob estimation
- Gas pricing (EIP-4844 pricing model)

## Availability

Check WASM availability:

```typescript
import { isWasmBlobAvailable, getImplementationStatus } from './Blob.wasm.js';

if (isWasmBlobAvailable()) {
  console.log("WASM acceleration available");
} else {
  console.log("Using pure TypeScript implementation");
}

// Detailed status
const status = getImplementationStatus();
console.log(status);
// {
//   wasmAvailable: true,
//   primitives: {
//     fromData: true,
//     toData: true,
//     isValid: true,
//     calculateGas: true,
//     estimateBlobCount: true,
//     calculateGasPrice: true,
//     calculateExcessGas: true,
//   }
// }
```

## WASM Functions

### fromDataWasm

Encodes data as blob using WASM.

#### Signature

```typescript
function fromDataWasm(data: Uint8Array): Uint8Array
```

#### Parameters

- `data` - Data to encode (max ~131KB)

#### Returns

`Uint8Array` - 131072-byte blob

#### Example

```typescript
import { fromDataWasm } from './Blob.wasm.js';

const data = new TextEncoder().encode("Hello, WASM!");
const blob = fromDataWasm(data);
// blob.length === 131072
```

#### Performance

Faster than pure TypeScript for large data:
- Small (< 1KB): ~2x faster
- Medium (~64KB): ~3-5x faster
- Large (~130KB): ~5-10x faster

---

### toDataWasm

Extracts data from blob using WASM.

#### Signature

```typescript
function toDataWasm(blob: Uint8Array): Uint8Array
```

#### Parameters

- `blob` - Blob data (131072 bytes)

#### Returns

`Uint8Array` - Original data

#### Example

```typescript
import { toDataWasm } from './Blob.wasm.js';

const data = toDataWasm(blob);
const text = new TextDecoder().decode(data);
```

#### Performance

Faster than pure TypeScript:
- Small data: ~2x faster
- Large data: ~5-10x faster

---

### isValidWasm

Validates blob size using WASM.

#### Signature

```typescript
function isValidWasm(blobLen: number): boolean
```

#### Parameters

- `blobLen` - Length to validate

#### Returns

`boolean` - `true` if exactly 131072

#### Example

```typescript
import { isValidWasm } from './Blob.wasm.js';

if (!isValidWasm(blob.length)) {
  throw new Error("Invalid blob");
}
```

#### Note

Takes length as parameter (not full blob) for efficiency.

---

### calculateGasWasm

Calculates blob gas using WASM.

#### Signature

```typescript
function calculateGasWasm(blobCount: number): bigint
```

#### Parameters

- `blobCount` - Number of blobs (0-6)

#### Returns

`bigint` - Total blob gas

#### Example

```typescript
import { calculateGasWasm } from './Blob.wasm.js';

const gas = calculateGasWasm(3);
console.log(gas); // 393216n
```

#### Note

Returns bigint (WASM uses 64-bit integers).

---

### estimateBlobCountWasm

Estimates blobs needed using WASM.

#### Signature

```typescript
function estimateBlobCountWasm(dataSize: number): number
```

#### Parameters

- `dataSize` - Data size in bytes

#### Returns

`number` - Number of blobs required

#### Example

```typescript
import { estimateBlobCountWasm } from './Blob.wasm.js';

const count = estimateBlobCountWasm(200000);
console.log(count); // 2
```

---

### calculateGasPriceWasm

Calculates blob gas price from excess gas (EIP-4844 pricing).

#### Signature

```typescript
function calculateGasPriceWasm(excessBlobGas: bigint): bigint
```

#### Parameters

- `excessBlobGas` - Excess blob gas from previous block

#### Returns

`bigint` - Blob gas price (wei)

#### Formula

```
price = MIN_BLOB_BASE_FEE Ã— e^(excess_blob_gas / BLOB_BASE_FEE_UPDATE_FRACTION)
```

Where:
- `MIN_BLOB_BASE_FEE = 1 wei`
- `BLOB_BASE_FEE_UPDATE_FRACTION = 3338477`

#### Example

```typescript
import { calculateGasPriceWasm } from './Blob.wasm.js';

// No excess (minimum price)
const minPrice = calculateGasPriceWasm(0n);
console.log(minPrice); // 1n

// With excess
const price = calculateGasPriceWasm(1000000n);
console.log(price); // Higher than minimum
```

#### See Also

- [EIP-4844: Blob Gas Price](https://eips.ethereum.org/EIPS/eip-4844#gas-accounting)

---

### calculateExcessGasWasm

Calculates excess blob gas for next block.

#### Signature

```typescript
function calculateExcessGasWasm(
  parentExcess: bigint,
  parentUsed: bigint
): bigint
```

#### Parameters

- `parentExcess` - Parent block excess blob gas
- `parentUsed` - Parent block blob gas used

#### Returns

`bigint` - Excess blob gas for next block

#### Formula

```
excess = max(0, parentExcess + parentUsed - TARGET_GAS_PER_BLOCK)
```

Where `TARGET_GAS_PER_BLOCK = 393216`.

#### Example

```typescript
import { calculateExcessGasWasm } from './Blob.wasm.js';

// Parent used 4 blobs (524288 gas), no prior excess
const excess = calculateExcessGasWasm(0n, 524288n);
console.log(excess); // 131072n (524288 - 393216)

// Below target (no excess)
const noExcess = calculateExcessGasWasm(0n, 262144n);
console.log(noExcess); // 0n
```

#### See Also

- [EIP-4844: Blob Gas Accounting](https://eips.ethereum.org/EIPS/eip-4844#gas-accounting)

---

## Usage Patterns

### Hybrid Approach

Use WASM when available, fallback to TypeScript:

```typescript
import { isWasmBlobAvailable, fromDataWasm } from './Blob.wasm.js';
import { fromData } from './BrandedBlob/fromData.js';

function encodeBlob(data: Uint8Array): Uint8Array {
  if (isWasmBlobAvailable()) {
    return fromDataWasm(data);
  }
  return fromData(data);
}
```

### Performance-Critical Paths

```typescript
import { isWasmBlobAvailable, toDataWasm } from './Blob.wasm.js';
import { toData } from './BrandedBlob/toData.js';

function decodeManyBlobs(blobs: Uint8Array[]): Uint8Array[] {
  const decoder = isWasmBlobAvailable() ? toDataWasm : toData;
  return blobs.map(decoder);
}
```

### Gas Calculations

```typescript
import {
  calculateGasPriceWasm,
  calculateExcessGasWasm,
} from './Blob.wasm.js';

function estimateBlobCost(
  blobCount: number,
  currentExcess: bigint,
  currentUsed: bigint
): bigint {
  // Calculate excess for next block
  const nextExcess = calculateExcessGasWasm(currentExcess, currentUsed);

  // Get gas price
  const price = calculateGasPriceWasm(nextExcess);

  // Calculate total cost
  const gas = BigInt(blobCount) * 131072n;
  return gas * price;
}
```

### Batch Processing

```typescript
import { fromDataWasm, isWasmBlobAvailable } from './Blob.wasm.js';

function batchEncode(datasets: Uint8Array[]): Uint8Array[] {
  if (!isWasmBlobAvailable()) {
    console.warn("WASM not available, performance may be reduced");
  }

  return datasets.map(data => fromDataWasm(data));
}
```

## Performance Comparison

### Encoding (fromData)

| Data Size | TypeScript | WASM | Speedup |
|-----------|-----------|------|---------|
| 1 KB | 500k ops/s | 1M ops/s | 2x |
| 64 KB | 100k ops/s | 400k ops/s | 4x |
| 131 KB | 50k ops/s | 400k ops/s | 8x |

### Decoding (toData)

| Data Size | TypeScript | WASM | Speedup |
|-----------|-----------|------|---------|
| 1 KB | 800k ops/s | 1.6M ops/s | 2x |
| 64 KB | 200k ops/s | 800k ops/s | 4x |
| 131 KB | 100k ops/s | 800k ops/s | 8x |

### Gas Calculations

| Operation | TypeScript | WASM | Speedup |
|-----------|-----------|------|---------|
| calculateGas | ~50M ops/s | ~100M ops/s | 2x |
| estimateBlobCount | ~50M ops/s | ~100M ops/s | 2x |
| calculateGasPrice | ~10M ops/s | ~50M ops/s | 5x |

## Implementation Details

### Zig Backend

WASM functions backed by Zig implementation:

```zig
// src/primitives/Blob/blob.zig
pub fn fromData(data: []const u8) [SIZE]u8 { ... }
pub fn toData(blob: [SIZE]u8) []u8 { ... }
pub fn isValid(blob_len: usize) bool { ... }
pub fn calculateGas(blob_count: u64) u64 { ... }
pub fn estimateBlobCount(data_size: u64) u64 { ... }
pub fn calculateGasPrice(excess: u64) u64 { ... }
pub fn calculateExcessGas(parent_excess: u64, parent_used: u64) u64 { ... }
```

### Loader

WASM loaded via primitives loader:

```typescript
import * as loader from "../../wasm-loader/loader.js";

export function fromDataWasm(data: Uint8Array): Uint8Array {
  return loader.blobFromData(data);
}
```

### Loading

WASM loaded lazily on first use. Check availability with:

```typescript
isWasmBlobAvailable() // Returns true if WASM loaded
```

## Limitations

### Not Available for KZG

WASM does not provide:
- `toCommitment` (requires c-kzg-4844)
- `toProof` (requires c-kzg-4844)
- `verify` (requires c-kzg-4844)
- `verifyBatch` (requires c-kzg-4844)

These require separate c-kzg-4844 library.

### Memory

WASM operations allocate memory:
- Encoding: Allocates 131KB per blob
- Decoding: Allocates data size
- Use pooling for high-throughput scenarios

## Building

WASM built from Zig source:

```bash
zig build -Doptimize=ReleaseFast
```

Output: `zig-out/lib/primitives.wasm`

## See Also

- [blob.zig](/src/primitives/Blob/blob.zig) - Zig implementation
- [Blob.bench.ts](/src/primitives/Blob/Blob.bench.ts) - Performance benchmarks
- [wasm-loader](/src/wasm-loader) - WASM loading utilities
