# Hardfork

Ethereum protocol upgrade identification and comparison utilities.

## Overview

Ethereum hardforks are protocol upgrades that change EVM behavior, gas costs, or add features. Each hardfork builds upon previous ones, maintaining backward compatibility while adding improvements. This module provides type-safe hardfork identification, version comparison, and feature detection.

```typescript
import { Hardfork } from '@tevm/voltaire';

const fork = Hardfork.fromString("cancun");
if (fork.hasEIP4844()) {
  // Blob transactions available
}
```

## Core Concepts

### Hardfork Type

Hardforks are represented as branded strings with comparison and feature detection methods:

```typescript
type BrandedHardfork = string & { __tag: "Hardfork" };
```

### Chronological Order

Hardforks follow chronological protocol evolution:
- **Frontier** (2015) → **Homestead** (2016) → **Byzantium** (2017)
- **Constantinople** (2019) → **Istanbul** (2019) → **Berlin** (2021)
- **London** (2021) → **Merge** (2022) → **Shanghai** (2023)
- **Cancun** (2024) → **Prague** (2025) → **Osaka** (TBD)

### Key Features

**Version Comparison:**
```typescript
Hardfork.isAtLeast(current, target)  // current >= target
Hardfork.isBefore(current, target)    // current < target
Hardfork.compare(a, b)                // -1, 0, 1
```

**Feature Detection:**
```typescript
Hardfork.hasEIP1559(fork)   // EIP-1559 base fee (London+)
Hardfork.hasEIP3855(fork)   // PUSH0 opcode (Shanghai+)
Hardfork.hasEIP4844(fork)   // Blob transactions (Cancun+)
Hardfork.isPostMerge(fork)  // Proof of Stake (Merge+)
```

**String Parsing:**
```typescript
Hardfork.fromString("cancun")        // Case-insensitive
Hardfork.fromString("paris")         // Alias → MERGE
Hardfork.fromString(">=Berlin")      // Strips operators
Hardfork.toString(fork)              // Normalized name
```

## API Structure

### Factory

```typescript
Hardfork(value: string): Hardfork
Hardfork.fromString(value: string): Hardfork | undefined
```

### Constants

All hardfork constants available:
```typescript
FRONTIER, HOMESTEAD, DAO, TANGERINE_WHISTLE, SPURIOUS_DRAGON
BYZANTIUM, CONSTANTINOPLE, PETERSBURG, ISTANBUL, MUIR_GLACIER
BERLIN, LONDON, ARROW_GLACIER, GRAY_GLACIER, MERGE
SHANGHAI, CANCUN, PRAGUE, OSAKA

Hardfork.DEFAULT  // PRAGUE
```

### Comparison Methods

[See comparisons.mdx](./comparisons.mdx) for full details:
- `isAtLeast(current, target)` - Check if current >= target
- `isBefore(current, target)` - Check if current < target
- `isAfter(current, target)` - Check if current > target
- `isEqual(a, b)` - Equality check
- `compare(a, b)` - Three-way comparison
- `gte/lt/gt/eq/lte` - Convenience forms

### Feature Detection

[See features.mdx](./features.mdx) for all feature methods:
- `hasEIP1559(fork)` - EIP-1559 base fee mechanism
- `hasEIP3855(fork)` - PUSH0 opcode
- `hasEIP4844(fork)` - Blob transactions
- `hasEIP1153(fork)` - Transient storage (TLOAD/TSTORE)
- `isPostMerge(fork)` - Proof of Stake consensus

### Utilities

[See utilities.mdx](./utilities.mdx) for utility functions:
- `allNames()` - All hardfork names
- `allIds()` - All hardfork IDs
- `range(start, end)` - Range of hardforks
- `min(forks)` - Minimum hardfork
- `max(forks)` - Maximum hardfork

## Quick Examples

### Version Gating

```typescript
import { Hardfork, CANCUN, LONDON } from '@tevm/voltaire';

const fork = Hardfork.fromString("cancun");

// Check minimum version
if (Hardfork.isAtLeast(fork, LONDON)) {
  // EIP-1559 available
}

// Feature-based check
if (Hardfork.hasEIP4844(fork)) {
  // Use blob transactions
}
```

### Network Configuration

```typescript
function getNetworkCapabilities(hardfork: string) {
  const fork = Hardfork.fromString(hardfork);
  if (!fork) throw new Error("Invalid hardfork");

  return {
    consensus: Hardfork.isPostMerge(fork) ? "PoS" : "PoW",
    eip1559: Hardfork.hasEIP1559(fork),
    push0: Hardfork.hasEIP3855(fork),
    blobs: Hardfork.hasEIP4844(fork),
    transientStorage: Hardfork.hasEIP1153(fork),
  };
}
```

### Upgrade Path

```typescript
import { BERLIN, CANCUN, range } from '@tevm/voltaire';

// Get all hardforks between two versions
const upgradePath = range(BERLIN, CANCUN);
// [BERLIN, LONDON, ARROW_GLACIER, GRAY_GLACIER, MERGE, SHANGHAI, CANCUN]

console.log(`${upgradePath.length} hardforks to upgrade through`);
```

## Documentation Sections

- **[hardforks.mdx](./hardforks.mdx)** - Complete hardfork timeline with all features
- **[comparisons.mdx](./comparisons.mdx)** - Version comparison methods
- **[features.mdx](./features.mdx)** - EIP feature detection
- **[utilities.mdx](./utilities.mdx)** - Utility functions
- **[usage-patterns.mdx](./usage-patterns.mdx)** - Common patterns and examples
- **[branded-hardfork.mdx](./branded-hardfork.mdx)** - Branded type pattern
- **[wasm.mdx](./wasm.mdx)** - WASM implementation status

## Performance

All operations are O(1):
- **Comparisons**: Simple array index lookups (~10-20ns)
- **Feature detection**: Single comparison + branch (~15-30ns)
- **String parsing**: Hash table lookup (~50-100ns)
- **String conversion**: Array index (~20-40ns)

No WASM implementation - pure TypeScript is optimal for these operations. WASM overhead (1-2μs) would make operations 10-100x slower.

## Implementation

- **Type**: Branded string (`string & { __tag: "Hardfork" }`)
- **Storage**: Chronologically ordered array
- **Comparison**: Array index comparison
- **Parsing**: Hash table with lowercase keys
- **Aliases**: "paris" → MERGE, "constantinoplefix" → PETERSBURG

## Best Practices

1. **Use feature detection over version checks**
   ```typescript
   // Good - explicit about requirements
   if (Hardfork.hasEIP4844(fork)) { /* ... */ }

   // Less clear - couples to version
   if (Hardfork.isAtLeast(fork, CANCUN)) { /* ... */ }
   ```

2. **Validate user input**
   ```typescript
   const fork = Hardfork.fromString(userInput);
   if (!fork) throw new Error("Invalid hardfork");
   ```

3. **Normalize for storage**
   ```typescript
   const normalized = Hardfork.toString(fork);
   ```

4. **Use convenience forms for readability**
   ```typescript
   if (fork.supportsBlobs()) { /* ... */ }
   ```

## Related Primitives

- **Network** - Chain ID and network configuration
- **Transaction** - Transaction type selection based on hardfork
- **Block** - Block structure changes per hardfork
